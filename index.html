<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>2026Â§ßÈóúË•ø‚ùÑÔ∏èÊï£Á≠ñ V49 (ÊâãÊ©üÁâàÈù¢ÂÑ™ÂåñÁâà)</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React & Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- SheetJS & Tesseract -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src='https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js'></script>

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#F48FB1">

  <!-- Dynamic Icon Targets -->
  <link id="app-icon" rel="apple-touch-icon" href="">
  <link id="fav-icon" rel="icon" type="image/png" href="">

  <!-- Google Fonts: Zen Maru Gothic -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700;900&display=swap" rel="stylesheet">

  <style>
    /* Global Styles & Variables */
    :root {
      --bg-color: #FCE4EC;
      --paper-color: #FFFFFF;
      --text-color: #4A4A4A;
    }

    body { 
      font-family: 'Zen Maru Gothic', sans-serif;
      background-color: var(--bg-color); 
      -webkit-tap-highlight-color: transparent; 
      overscroll-behavior-y: none; 
      user-select: none;
      font-weight: 700;
      color: var(--text-color);
      height: 100dvh;
      width: 100vw;
      overflow: hidden;
      position: fixed;
    }
    
    #root {
      height: 100%;
      width: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .safe-area-top { padding-top: env(safe-area-inset-top); background-color: #F48FB1; }
    .safe-area-bottom { padding-bottom: max(env(safe-area-inset-bottom), 20px); background-color: white; }
    
    /* Ticket / Jagged Box Style */
    .ticket-box {
      position: relative;
      background: var(--paper-color);
      filter: drop-shadow(0px 2px 2px rgba(0,0,0,0.1));
      margin-bottom: 25px; 
      border-radius: 4px 4px 0 0;
    }
    .ticket-box::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -10px;
      width: 100%;
      height: 10px;
      background: 
        linear-gradient(135deg, var(--paper-color) 50%, transparent 50%), 
        linear-gradient(225deg, var(--paper-color) 50%, transparent 50%);
      background-position: 0 0, 10px 0;
      background-size: 20px 20px;
      background-repeat: repeat-x;
    }

    .dashed-input {
      border: 2px dashed #CFD8DC;
      background-color: #FAFAFA;
      border-radius: 8px;
      transition: all 0.2s;
    }
    .dashed-input:focus-within {
      border-color: #F48FB1;
      background-color: #FFF;
    }
    
    /* Input inside dashed group */
    .input-clean {
        background: transparent;
        border: none;
        outline: none;
        width: 100%;
    }

    /* Calculator Specific Styles */
    .calc-btn {
      background: white;
      border: 2px solid #E0E0E0;
      border-radius: 12px;
      font-size: 1.25rem;
      font-weight: 900;
      color: #555;
      box-shadow: 0 3px 0 #E0E0E0;
      transition: all 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .calc-btn:active {
      transform: translateY(3px);
      box-shadow: none;
    }
    .calc-btn-op {
      background: #FFF3E0;
      border-color: #FFE0B2;
      box-shadow: 0 3px 0 #FFE0B2;
      color: #E65100;
    }
    .calc-btn-ok {
      background: #F48FB1;
      border-color: #EC407A;
      box-shadow: 0 3px 0 #C2185B;
      color: white;
    }

    .washi-tape {
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%) rotate(-1.5deg);
      width: 70px;
      height: 16px;
      background-color: rgba(255, 255, 255, 0.5);
      background-image: repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(233, 30, 99, 0.15) 5px, rgba(233, 30, 99, 0.15) 10px);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      z-index: 20;
      opacity: 0.95;
      pointer-events: none;
      border-left: 2px solid rgba(255,255,255,0.4);
      border-right: 2px solid rgba(255,255,255,0.4);
    }
    .washi-tape:nth-child(even) { transform: translateX(-50%) rotate(1deg); background-image: repeating-linear-gradient(-45deg, transparent, transparent 5px, rgba(33, 150, 243, 0.15) 5px, rgba(33, 150, 243, 0.15) 10px); }
    
    .paper-texture { 
        background-color: #FFFDF7; 
        background-image: radial-gradient(#E0E0E0 1px, transparent 1px);
        background-size: 20px 20px;
    }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .fade-in { animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    input, select, textarea { font-size: 16px !important; /* Fixed 16px to prevent iOS zoom */ font-family: 'Zen Maru Gothic', sans-serif; font-weight: 700; }
    
    .snap-x-mandatory { scroll-snap-type: x mandatory; }
    .snap-center { scroll-snap-align: center; }
    .loading-spin { animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .modal-backdrop {
      background-color: rgba(93, 64, 55, 0.6); 
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
    }

    /* Paid Stamp Animation */
    .stamp-animation {
        animation: stamp 0.3s ease-out forwards;
    }
    @keyframes stamp {
        0% { transform: scale(3) rotate(-20deg); opacity: 0; }
        100% { transform: scale(1) rotate(-10deg); opacity: 1; }
    }

    /* Print Styles */
    @media print {
      body, #root { position: relative; height: auto; overflow: visible; background: white; }
      body * { visibility: hidden; }
      #booklet-root, #booklet-root * { visibility: visible; }
      #booklet-root { position: absolute; left: 0; top: 0; width: 100%; z-index: 9999; background: white; color: black; font-family: 'Zen Maru Gothic', sans-serif; }
      .page-break { page-break-before: always; }
      .avoid-break { page-break-inside: avoid; }
      .safe-area-top, .safe-area-bottom, .modal-backdrop, .print-hidden { display: none !important; }
      /* Hide buttons in print view */
      .no-print { display: none !important; }
    }
    
    .sparkle-btn { background: linear-gradient(45deg, #F48FB1, #FFD54F); color: white; border: 2px solid white; box-shadow: 0 4px 10px rgba(244, 143, 177, 0.4); border-radius: 20px; }
  </style>
</head>
<body class="bg-[#FCE4EC]">
  <div id="root"></div>
  <div id="booklet-root"></div>

  <!-- Icon Generator: Pink Winter Edition -->
  <script>
    window.addEventListener('load', function() {
      try {
        const svgString = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
          <rect width="512" height="512" fill="#F48FB1"/>
          <defs>
            <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="2" dy="4" stdDeviation="4" flood-opacity="0.2"/>
            </filter>
          </defs>
          <circle cx="100" cy="100" r="15" fill="white" opacity="0.3"/>
          <circle cx="420" cy="60" r="20" fill="white" opacity="0.2"/>
          <circle cx="50" cy="350" r="10" fill="white" opacity="0.4"/>
          <circle cx="460" cy="400" r="12" fill="white" opacity="0.3"/>
          <circle cx="256" cy="40" r="8" fill="white" opacity="0.5"/>
          <circle cx="350" cy="150" r="6" fill="white" opacity="0.4"/>
          <g transform="translate(136, 120) scale(0.47)" fill="white" filter="url(#shadow)">
             <path d="M 0 0 L 512 0 L 522 -50 L -10 -50 Z" />
             <rect x="40" y="30" width="432" height="50" />
             <rect x="100" y="80" width="60" height="400" rx="5" />
             <rect x="352" y="80" width="60" height="400" rx="5" />
             <rect x="100" y="160" width="312" height="40" />
          </g>
          <g transform="translate(60, 60)" opacity="0.9">
             <path d="M20 0 L20 40 M0 20 L40 20 M6 6 L34 34 M6 34 L34 6" stroke="white" stroke-width="4" stroke-linecap="round"/>
          </g>
          <g transform="translate(400, 100) scale(1.5)" opacity="0.8">
             <path d="M20 0 L20 40 M0 20 L40 20 M6 6 L34 34 M6 34 L34 6" stroke="white" stroke-width="3" stroke-linecap="round"/>
          </g>
          <text x="50%" y="380" font-family="sans-serif" font-size="140" font-weight="900" fill="white" text-anchor="middle" letter-spacing="-5" filter="url(#shadow)">2026</text>
          <rect x="156" y="410" width="200" height="40" rx="20" fill="white" opacity="0.9"/>
          <text x="50%" y="438" font-family="sans-serif" font-size="24" font-weight="bold" fill="#F48FB1" text-anchor="middle" letter-spacing="4">KANSAI</text>
        </svg>
        `;
        const canvas = document.createElement('canvas'); canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d'); const img = new Image(); 
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgString)));
        img.onload = function() { 
            let appIcon = document.getElementById('app-icon'); if(!appIcon) { appIcon = document.createElement('link'); appIcon.id = 'app-icon'; appIcon.rel = 'apple-touch-icon'; document.head.appendChild(appIcon); }
            let favIcon = document.getElementById('fav-icon'); if(!favIcon) { favIcon = document.createElement('link'); favIcon.id = 'fav-icon'; favIcon.rel = 'icon'; favIcon.type = 'image/png'; document.head.appendChild(favIcon); }
            ctx.drawImage(img, 0, 0); const pngUrl = canvas.toDataURL('image/png'); appIcon.href = pngUrl; favIcon.href = pngUrl; 
        };
      } catch(e) { console.warn("Icon gen failed", e); }
    });
  </script>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    const apiKey = ""; // Ë´ãÂú®Ê≠§Â°´ÂÖ•ÊÇ®ÁöÑ Gemini API Key

    const callGeminiAPI = async (prompt) => {
        if (!apiKey) { alert("Ë´ãÂÖàË®≠ÂÆö API Key ÊâçËÉΩ‰ΩøÁî® AI ÂäüËÉΩ"); return ""; }
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = { contents: [{ parts: [{ text: prompt }] }] };
        const delays = [1000, 2000, 4000];
        for (let i = 0; i < 3; i++) {
            try {
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (error) { if (i === 2) throw error; await new Promise(resolve => setTimeout(resolve, delays[i])); }
        }
    };

    const Icon = ({ children, size = 24, className = "" }) => (
      <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
    );
    const Icons = {
      Plus: (p) => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>,
      Trash2: (p) => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>,
      Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>,
      Upload: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></Icon>,
      ShoppingBag: (p) => <Icon {...p}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></Icon>,
      Map: (p) => <Icon {...p}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></Icon>,
      Coins: (p) => <Icon {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7.71-2.82 2.82"/></Icon>,
      Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>,
      X: (p) => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>,
      FileSpreadsheet: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></Icon>,
      Settings: (p) => <Icon {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.72l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.72l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></Icon>,
      Refresh: (p) => <Icon {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></Icon>,
      Camera: (p) => <Icon {...p}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></Icon>,
      Navigation: (p) => <Icon {...p}><polygon points="3 11 22 2 13 21 11 13 3 11"/></Icon>,
      Loader: (p) => <Icon {...p}><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"/><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"/><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"/></Icon>,
      Image: (p) => <Icon {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>,
      Suitcase: (p) => <Icon {...p}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></Icon>,
      Calendar: (p) => <Icon {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></Icon>,
      Star: (p) => <Icon {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>,
      Utensils: (p) => <Icon {...p}><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></Icon>,
      Train: (p) => <Icon {...p}><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16"/><path d="M12 3v8"/><path d="m8 19-2 3"/><path d="m18 22-2-3"/><path d="M8 15h0"/><path d="M16 15h0"/></Icon>,
      Home: (p) => <Icon {...p}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></Icon>,
      ListPlus: (p) => <Icon {...p}><path d="M11 12H3"/><path d="M16 6H3"/><path d="M16 18H3"/><path d="M18 9v6"/><path d="M21 12h-6"/></Icon>,
      Clock: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
      CloudSun: (p) => <Icon {...p}><path d="M12 2v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="M20 12h2"/><path d="m19.07 4.93-1.41 1.41"/><path d="M15.947 12.65a4 4 0 0 0-5.925-4.128"/><path d="M13 22H7a5 5 0 1 1 4.9-6H13a3 3 0 0 1 0 6Z"/></Icon>,
      ArrowUp: (p) => <Icon {...p}><path d="m18 15-6-6-6 6"/></Icon>,
      ArrowDown: (p) => <Icon {...p}><path d="m6 9 6 6 6-6"/></Icon>,
      Save: (p) => <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>,
      User: (p) => <Icon {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></Icon>,
      Info: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></Icon>,
      Phone: (p) => <Icon {...p}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></Icon>,
      Ticket: (p) => <Icon {...p}><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 12h.01M18 12h.01"/></Icon>,
      Bed: (p) => <Icon {...p}><path d="M2 4v16"/><path d="M2 8h18a2 2 0 0 1 2 2v10"/><path d="M2 17h20"/><path d="M6 8v9"/></Icon>,
      Book: (p) => <Icon {...p}><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></Icon>,
      Printer: (p) => <Icon {...p}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>,
      Sparkles: (p) => <Icon {...p}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H5"/><path d="M19 17v4"/><path d="M15 19h4"/></Icon>,
      Edit: (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>,
      Word: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>,
      Delete: (p) => <Icon {...p}><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="18" x2="12" y1="9" y2="15"/><line x1="12" x2="18" y1="9" y2="15"/></Icon>
    };

    const INITIAL_ITINERARY = [{ id: 1, date: '2026-02-02', weekday: 'Êó•', content: '', transport: 'ÂêçÈñÄÂ§ßÊ¥ãÊ∏°Ëº™', stay: 'Ëàπ‰∏ä', food: 'Ëàπ‰∏äËá™Âä©È§ê', highlights: 'Ê¨£Ë≥ûÁÄ®Êà∂ÂÖßÊµ∑Â§úÊôØ', photo: null, schedule: [{ id: 101, time: '15:00', category: '‰∫§ÈÄö', activity: 'ÂâçÂæÄÂçóÊ∏ØÊ∏°Ëº™Á´ô', note: 'ÊèêÊó©check-in' }, { id: 102, time: '17:00', category: '‰∫§ÈÄö', activity: 'ÂêçÈñÄÂ§ßÊ¥ãÊ∏°Ëº™ Âá∫Áôº', note: 'Ê¨£Ë≥ûÂ§ïÈôΩ' }] }, { id: 2, date: '2026-02-03', weekday: '‰∏Ä', content: '', transport: 'JR / Ê≠•Ë°å', stay: 'Á¶èÂ≤° Quintessa', food: 'ÁáíÂíñÂì©', highlights: 'Êá∑ËàäÂª∫ÁØâ„ÄÅÂ∞èÂÄâÂüé', photo: null, schedule: [{ id: 201, time: '08:30', category: '‰∫§ÈÄö', activity: 'ÊäµÈÅîÈñÄÂè∏Ê∏Ø', note: '‰∏ãËàπ' }, { id: 202, time: '10:00', category: 'ÊôØÈªû', activity: 'ÈñÄÂè∏Ê∏ØÊá∑ËàäÂçÄ', note: 'ÊãçÁÖß' }] }];
    const INITIAL_SHOPPING = [{ id: 1, item: 'ÂêàÂà©‰ªñÂëΩ', budget: 5000, bought: false, store: 'ÊùæÊú¨Ê∏Ö', priority: 'high', type: 'self', note: '' }];
    const INITIAL_PACKING_CATEGORIES = ['ÈáçË¶ÅË≠â‰ª∂ & Èö®Ë∫´', 'Ê¥óÊº± & Ë≠∑ÁêÜ', 'ÈÜ´Ëó• & ‰øùÂÅ•', 'ÁæéÂ¶ù & ‰øùÈ§ä', 'Ë°£Áâ© & Á©øÊê≠', 'ÈõªÂ≠ê & ÈõúÁâ©'];
    const INITIAL_PACKING_LIST = [{ id: 101, category: 'ÈáçË¶ÅË≠â‰ª∂ & Èö®Ë∫´', item: 'Ë≠∑ÁÖß / Á∞ΩË≠â', checked: false }, { id: 102, category: 'ÈáçË¶ÅË≠â‰ª∂ & Èö®Ë∫´', item: 'Ê©üÁ•® / ÊÜëË≠â (VJWÊà™Âúñ)', checked: false }, { id: 103, category: 'ÈáçË¶ÅË≠â‰ª∂ & Èö®Ë∫´', item: 'Èå¢ÂåÖ (ÁèæÈáë/‰ø°Áî®Âç°)', checked: false }, { id: 104, category: 'ÈáçË¶ÅË≠â‰ª∂ & Èö®Ë∫´', item: 'Ë°åÂãïÈõªÊ∫ê', checked: false }, { id: 501, category: 'Ë°£Áâ© & Á©øÊê≠', item: 'ÊèõÊ¥óË°£Áâ©', checked: false }];
    const INITIAL_PAYMENT_METHODS = ['ÁèæÈáë', '‰ø°Áî®Âç°(‰∏≠‰ø°)', '‰ø°Áî®Âç°(ÂØåÈÇ¶J)', 'Ë•øÁìúÂç°'];
    const INITIAL_BOOKING_PLATFORMS = ['ÁèæÂ†¥', 'Agoda', 'Booking', 'ÂÆòÁ∂≤', 'Klook', 'Êù±Ê©´INN'];
    const CATEGORIES = ['üçú È£≤È£ü', 'üöÉ ‰∫§ÈÄö', 'üè® ‰ΩèÂÆø', 'üõçÔ∏è Ë≥ºÁâ©', 'üé´ ÈñÄÁ•®', 'üìù ÂÖ∂‰ªñ'];
    const SCHEDULE_CATEGORIES = [{ name: 'ÊôØÈªû', color: '#E64A19' }, { name: 'ÂêÉÈ£Ø', color: '#F57C00' }, { name: 'ÈÄõË°ó', color: '#C2185B' }, { name: '‰∫§ÈÄö', color: '#455A64' }, { name: '‰ΩèÂÆø', color: '#303F9F' }, { name: 'ÂΩàÊÄß', color: '#00796B' }];
    const CITIES = ['Â§ßÈò™', '‰∫¨ÈÉΩ', 'Á•ûÊà∂', 'Â•àËâØ', 'Âß¨Ë∑Ø', 'ÂÆáÊ≤ª', 'ÂÖ∂‰ªñ'];
    const CURRENCIES = [
        { code: 'JPY', label: 'üáØüáµ JPY', symbol: '¬•' },
        { code: 'TWD', label: 'üáπüáº TWD', symbol: '$' },
        { code: 'USD', label: 'üá∫üá∏ USD', symbol: '$' },
        { code: 'KRW', label: 'üá∞üá∑ KRW', symbol: '‚Ç©' }
    ];
    const BUTTON_COLORS = ['#FF9F43', '#4ECDC4', '#FF6B6B', '#6C5CE7', '#FFA502'];

    const WeatherWidget = () => {
        const [weather, setWeather] = useState(null);
        const [time, setTime] = useState(new Date());
        useEffect(() => {
            const timer = setInterval(() => setTime(new Date()), 60000);
            const fetchWeather = async () => { try { const res = await fetch('https://api.open-meteo.com/v1/forecast?latitude=34.6937&longitude=135.5023&current_weather=true'); const data = await res.json(); setWeather(data.current_weather); } catch (e) { console.warn("Weather fetch failed"); } };
            fetchWeather(); return () => clearInterval(timer);
        }, []);
        return (<div className="flex gap-2 items-center text-white text-xs font-bold bg-black/20 rounded-xl px-3 py-1" style={{border: '1px solid rgba(255,255,255,0.3)', backgroundColor: 'rgba(0,0,0,0.2)'}}><span>{time.getHours().toString().padStart(2,'0')}:{time.getMinutes().toString().padStart(2,'0')}</span><span className="w-[1px] h-3 bg-white/50"></span><span>{weather ? `${weather.temperature}¬∞C` : '...'}</span></div>);
    };

    // --- Calculator Component ---
    const CalculatorModal = ({ isOpen, onClose, onConfirm, initialValue }) => {
        const [display, setDisplay] = useState(initialValue ? String(initialValue) : '');
        
        useEffect(() => { if (isOpen) setDisplay(initialValue ? String(initialValue) : ''); }, [isOpen, initialValue]);

        if (!isOpen) return null;

        const handleBtnClick = (val) => {
            if (val === 'C') { setDisplay(''); return; }
            if (val === 'DEL') { setDisplay(prev => prev.slice(0, -1)); return; }
            if (val === 'OK') {
                try {
                    // Safe eval alternative
                    const safeEval = new Function('return ' + display.replace(/[^0-9+\-*/.]/g, ''));
                    const result = safeEval();
                    onConfirm(result);
                    onClose();
                } catch (e) { alert("ÁÆóÂºèÈåØË™§ >_<"); }
                return;
            }
            setDisplay(prev => prev + val);
        };

        const btns = ['7','8','9','/', '4','5','6','*', '1','2','3','-', 'C','0','.','+', 'DEL','OK'];

        return (
            <div className="fixed inset-0 z-[80] flex items-center justify-center modal-backdrop" onClick={onClose}>
                <div className="bg-white w-[95%] max-w-sm p-5 fade-in ticket-box" style={{backgroundColor: '#FFF0F5'}} onClick={e => e.stopPropagation()}>
                    <div className="flex justify-between items-center mb-2">
                        <h3 className="font-bold text-lg text-gray-500">Â§™ÈôΩËÉΩË®àÁÆóÊ©ü ‚òÄÔ∏è</h3>
                        <button onClick={onClose}><Icons.X size={24} className="text-gray-400"/></button>
                    </div>
                    <div className="bg-[#E0F2F1] p-3 rounded-lg mb-4 text-right font-mono text-3xl text-gray-700 border-2 border-[#B2DFDB] overflow-x-auto h-16 flex items-center justify-end">
                        {display || '0'}
                    </div>
                    <div className="grid grid-cols-4 gap-2">
                        {btns.map(btn => (
                            <button key={btn} onClick={() => handleBtnClick(btn)} 
                                className={`calc-btn h-14 ${['/','*','-','+'].includes(btn) ? 'calc-btn-op' : ''} ${btn === 'OK' ? 'col-span-2 calc-btn-ok' : ''} ${btn === 'DEL' ? 'text-red-400' : ''}`}>
                                {btn === 'DEL' ? <Icons.Delete size={20}/> : btn}
                            </button>
                        ))}
                    </div>
                </div>
            </div>
        );
    };

    function App() {
      const loadState = (key, defaultVal) => { try { const val = localStorage.getItem(key); if (val === null) return defaultVal; const parsed = JSON.parse(val); return (Array.isArray(defaultVal) && !Array.isArray(parsed)) ? defaultVal : parsed; } catch (e) { return defaultVal; } };
      const saveState = (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); } catch (e) { console.warn("Storage Full", e); } };

      const [activeTab, setActiveTab] = useState('itinerary');
      const [itinerary, setItinerary] = useState(() => loadState('crab_itinerary_v23', INITIAL_ITINERARY));
      const [expenses, setExpenses] = useState(() => loadState('crab_expenses_v23', []) || []);
      const [shoppingList, setShoppingList] = useState(() => loadState('crab_shopping_v23', INITIAL_SHOPPING) || []);
      const [packingList, setPackingList] = useState(() => loadState('crab_packing_v23', INITIAL_PACKING_LIST) || []);
      const [packingCategories, setPackingCategories] = useState(() => loadState('crab_packing_cats_v23', INITIAL_PACKING_CATEGORIES));
      const [paymentMethods, setPaymentMethods] = useState(() => loadState('crab_methods_v23', INITIAL_PAYMENT_METHODS));
      const [bookingPlatforms, setBookingPlatforms] = useState(() => loadState('crab_platforms_v23', INITIAL_BOOKING_PLATFORMS));
      const [budgetSettings, setBudgetSettings] = useState(() => loadState('crab_budget_v23', { totalTWD: 50000, startDate: '2026-02-02', rates: { JPY_TWD: 0.215, USD_TWD: 31.5, KRW_TWD: 0.024, TWD_TWD: 1 } }));
      const [memoContent, setMemoContent] = useState(() => loadState('crab_memo_v24', ''));
      const [accommodations, setAccommodations] = useState(() => loadState('crab_accomm_v26', accommodations) || []);
      const [reservations, setReservations] = useState(() => loadState('crab_reserv_v26', reservations) || []);
      const [gourmetList, setGourmetList] = useState(() => loadState('crab_gourmet_v30', gourmetList) || []);

      const [showSettingsModal, setShowSettingsModal] = useState(false);
      const [showExportModal, setShowExportModal] = useState(false);
      const [showBatchModal, setShowBatchModal] = useState(false);
      const [showExpenseModal, setShowExpenseModal] = useState(false);
      const [showBooklet, setShowBooklet] = useState(false); 
      const [showAIModal, setShowAIModal] = useState(false);
      const [showBuyDateModal, setShowBuyDateModal] = useState(false); 
      const [tempBuyDate, setTempBuyDate] = useState(''); 
      const [tempBuyId, setTempBuyId] = useState(null); 
      const [showCalculator, setShowCalculator] = useState(false);
      const [calcTarget, setCalcTarget] = useState(null); // 'expense' or 'shopping'

      const [aiType, setAiType] = useState(null);
      const [aiInput1, setAiInput1] = useState('');
      const [aiInput2, setAiInput2] = useState('');
      const [isGenerating, setIsGenerating] = useState(false);

      const [batchType, setBatchType] = useState(null); 
      const [batchText, setBatchText] = useState('');
      const [expenseFilter, setExpenseFilter] = useState('all');
      const [currentDayIndex, setCurrentDayIndex] = useState(0);
      const dayScrollRef = useRef(null);
      const [isScanning, setIsScanning] = useState(false);
      const [scanType, setScanType] = useState(null); 
      const fileInputRef = useRef(null);
      const backupInputRef = useRef(null); 
      const [targetDayId, setTargetDayId] = useState(null); 
      const [newPackingItemText, setNewPackingItemText] = useState('');
      const [activePackingCategory, setActivePackingCategory] = useState(null);
      const [newCategoryName, setNewCategoryName] = useState('');
      const [editingScheduleId, setEditingScheduleId] = useState(null);
      
      const [newHotel, setNewHotel] = useState({ name: '', address: '', note: '', date: budgetSettings.startDate || '' });
      const [newReserv, setNewReserv] = useState({ title: '', time: '', code: '' });
      const [showAddHotel, setShowAddHotel] = useState(false);
      const [showAddReserv, setShowAddReserv] = useState(false);
      const [newGourmet, setNewGourmet] = useState({ name: '', city: 'Â§ßÈò™', location: '', photo: null, note: '' });
      const [showAddGourmet, setShowAddGourmet] = useState(false);

      // State effects
      useEffect(() => { saveState('crab_itinerary_v23', itinerary); }, [itinerary]);
      useEffect(() => { saveState('crab_expenses_v23', expenses); }, [expenses]);
      useEffect(() => { saveState('crab_shopping_v23', shoppingList); }, [shoppingList]);
      useEffect(() => { saveState('crab_packing_v23', packingList); }, [packingList]);
      useEffect(() => { saveState('crab_packing_cats_v23', packingCategories); }, [packingCategories]);
      useEffect(() => { saveState('crab_methods_v23', paymentMethods); }, [paymentMethods]);
      useEffect(() => { saveState('crab_platforms_v23', bookingPlatforms); }, [bookingPlatforms]);
      useEffect(() => { saveState('crab_budget_v23', budgetSettings); }, [budgetSettings]);
      useEffect(() => { saveState('crab_memo_v24', memoContent); }, [memoContent]);
      useEffect(() => { saveState('crab_accomm_v26', accommodations); }, [accommodations]);
      useEffect(() => { saveState('crab_reserv_v26', reservations); }, [reservations]);
      useEffect(() => { saveState('crab_gourmet_v30', gourmetList); }, [gourmetList]);

      const [newExpense, setNewExpense] = useState({ date: itinerary[0]?.date || '', item: '', amount: '', currency: 'JPY', category: 'üçú È£≤È£ü', method: paymentMethods[0], platform: bookingPlatforms[0], note: '' });
      const [editingExpenseId, setEditingExpenseId] = useState(null);
      const [newShopItem, setNewShopItem] = useState({ item: '', budget: '', store: '', priority: 'high', type: 'self', note: '', splitCount: 1 });

      const formatDate = (dateStr) => { if(!dateStr) return ''; const d = new Date(dateStr); return `${d.getMonth()+1}/${d.getDate()}`; };
      const getWeekday = (dateStr) => { const days = ['Êó•', '‰∏Ä', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', 'ÂÖ≠']; return days[new Date(dateStr).getDay()]; };

      const getExchangeRate = (currencyCode) => { return budgetSettings?.rates?.[`${currencyCode}_TWD`] || 1; };
      
      const totalSpentConvertedTWD = expenses.reduce((acc, curr) => acc + Math.round(curr.amount * getExchangeRate(curr.currency)), 0);

      const shoppingStats = shoppingList.reduce((acc, item) => {
        if (item.type === 'self') acc.selfTotal += item.budget;
        if (item.type === 'agent') acc.agentTotal += item.budget;
        return acc;
      }, { selfTotal: 0, agentTotal: 0 });

      const agentSummary = shoppingList.filter(i => i.type === 'agent').reduce((acc, item) => {
        if (!acc[item.note]) acc[item.note] = { jpy: 0, twd: 0 };
        acc[item.note].jpy += item.budget;
        acc[item.note].twd += Math.round(item.budget * getExchangeRate('JPY'));
        return acc;
      }, {});

      const getDailyTotal = (date) => (expenses || []).filter(e => e.date === date).reduce((acc, curr) => acc + Math.round(curr.amount * getExchangeRate(curr.currency)), 0);
      const openGoogleMaps = (e, content) => { e.stopPropagation(); if(!content) return; window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(content)}`, '_blank'); };
      const scrollToDay = (index) => { if (dayScrollRef.current) { const width = dayScrollRef.current.offsetWidth; dayScrollRef.current.scrollTo({ left: width * index, behavior: 'smooth' }); setCurrentDayIndex(index); }};

      const compressImage = (file) => {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    if (width > 800) { height = Math.round((height * 800) / width); width = 800; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.6));
                }; img.src = event.target.result;
            }; reader.readAsDataURL(file);
        });
      };

      const handleFileSelect = async (e) => {
        const file = e.target.files[0]; if (!file) return; setIsScanning(true);
        try {
            if (scanType === 'photo' && targetDayId) {
                const base64 = await compressImage(file);
                updateItinerary(targetDayId, 'photo', base64); alert('ÁÖßÁâáÂ∑≤ÂÑ≤Â≠òÔºÅ');
            } else if (scanType === 'gourmetPhoto' && targetDayId) {
                 const base64 = await compressImage(file);
                 if (targetDayId === 'new') { setNewGourmet(prev => ({ ...prev, photo: base64 })); } 
                 else { setGourmetList(gourmetList.map(g => g.id === targetDayId ? { ...g, photo: base64 } : g)); }
                 alert('ÁæéÈ£üÁÖßÁâáÂ∑≤Ê∫ñÂÇôÔºÅ');
            } else {
                if (typeof Tesseract === 'undefined') { alert('Ëæ®Ë≠òÂäüËÉΩËºâÂÖ•‰∏≠ÔºåË´ãÁ®çÂæåÂÜçË©¶'); return; }
                const { data: { text } } = await Tesseract.recognize(file, 'eng+jpn+chi_tra');
                
                if (scanType === 'receipt') {
                    const numbers = text.match(/\d{1,3}(,\d{3})*(\.\d+)?/g) || [];
                    const cleanNumbers = numbers.map(n => parseFloat(n.replace(/,/g, ''))).filter(n => n > 50 && n < 1000000); 
                    const maxAmount = cleanNumbers.length > 0 ? Math.max(...cleanNumbers) : '';
                    let guessedCategory = 'üçú È£≤È£ü';
                    const lowerText = text.toLowerCase();
                    if (lowerText.includes('uniqlo') || lowerText.includes('donki') || lowerText.includes('gu') || lowerText.includes('shop') || lowerText.includes('zara')) guessedCategory = 'üõçÔ∏è Ë≥ºÁâ©';
                    else if (lowerText.includes('bus') || lowerText.includes('train') || lowerText.includes('taxi') || lowerText.includes('subway') || lowerText.includes('ticket') || lowerText.includes('uber')) guessedCategory = 'üöÉ ‰∫§ÈÄö';
                    else if (lowerText.includes('hotel') || lowerText.includes('inn') || lowerText.includes('apa') || lowerText.includes('toyoko')) guessedCategory = 'üè® ‰ΩèÂÆø';
                    else if (lowerText.includes('lawson') || lowerText.includes('7-eleven') || lowerText.includes('family') || lowerText.includes('cafe') || lowerText.includes('starbucks') || lowerText.includes('restaurant')) guessedCategory = 'üçú È£≤È£ü';

                    setNewExpense(prev => ({ ...prev, amount: maxAmount || prev.amount, category: guessedCategory, note: 'OCRÊî∂ÊìöËæ®Ë≠ò' }));
                    alert(`Êî∂ÊìöËæ®Ë≠òÂÆåÊàêÔºÅ\nÂÅµÊ∏¨ÈáëÈ°ç: ¬•${maxAmount}\nÂàÜÈ°û: ${guessedCategory}`);
                } 
                else if (scanType === 'itineraryImport' && targetDayId) {
                    const lines = text.split('\n');
                    const newItems = [];
                    lines.forEach(line => {
                        const timeMatch = line.match(/(\d{1,2}[:Ôºö]\d{2})/);
                        if (timeMatch) {
                            const time = timeMatch[1].replace('Ôºö', ':');
                            const activity = line.replace(timeMatch[0], '').trim();
                            if(activity && activity.length > 1) {
                                newItems.push({ id: Date.now() + Math.random(), time: time.padStart(5, '0'), category: 'ÊôØÈªû', activity: activity, note: 'OCR ÂåØÂÖ•' });
                            }
                        }
                    });
                    if(newItems.length > 0) {
                         const updatedItinerary = itinerary.map(day => {
                             if(day.id === targetDayId) {
                                 const mergedSchedule = [...(day.schedule || []), ...newItems].sort((a,b) => a.time.localeCompare(b.time));
                                 return { ...day, schedule: mergedSchedule };
                             } return day;
                         });
                         setItinerary(updatedItinerary); alert(`ÊàêÂäüËæ®Ë≠ò‰∏¶ÂåØÂÖ• ${newItems.length} ÂÄãË°åÁ®ãÈ†ÖÁõÆÔºÅ`);
                    } else { alert('Êú™ËÉΩËæ®Ë≠òÂá∫ÊôÇÈñìÊ†ºÂºè (Â¶Ç 14:00)ÔºåË´ãÁ¢∫Ë™çÁÖßÁâáÊ∏ÖÊô∞Â∫¶'); }
                }
            }
        } catch (error) { console.error(error); alert('ËôïÁêÜÂ§±ÊïóÔºåË´ãÈáçË©¶'); } 
        finally { setIsScanning(false); if(fileInputRef.current) fileInputRef.current.value = ''; setScanType(null); setTargetDayId(null); }
      };

      const openAIPlanner = (dayId) => { setAiType('itinerary'); setTargetDayId(dayId); setAiInput1('Â§ßÈò™'); setAiInput2('ÊîæÈ¨Ü„ÄÅÈÄõË°ó'); setShowAIModal(true); };
      const openAIGourmet = () => { setAiType('gourmet'); setAiInput1('Â§ßÈò™'); setAiInput2('ÊãâÈ∫µ'); setShowAIModal(true); };

      const handleAIGenerate = async () => {
          if (!aiInput1 || !aiInput2) { alert('Ë´ãÂ°´ÂØ´ÂÆåÊï¥Ë≥áË®ä'); return; }
          setIsGenerating(true);
          try {
              if (aiType === 'itinerary') {
                  const day = itinerary.find(d => d.id === targetDayId);
                  const prompt = `Plan a one-day itinerary for ${day?.date} in ${aiInput1} with style: ${aiInput2}. Return JSON array: [{"time":"HH:MM","category":"ÊôØÈªû","activity":"Name","note":"Tip"}]`;
                  const resultText = await callGeminiAPI(prompt);
                  const newItems = JSON.parse(resultText.replace(/```json|```/g, '').trim());
                  if(Array.isArray(newItems)) {
                      const updatedItinerary = itinerary.map(d => d.id === targetDayId ? { ...d, schedule: [...(d.schedule || []), ...newItems.map(i=>({...i, id: Date.now()+Math.random()}))].sort((a,b) => a.time.localeCompare(b.time)) } : d);
                      setItinerary(updatedItinerary); alert('Ë°åÁ®ãË¶èÂäÉÂÆåÊàêÔºÅ'); setShowAIModal(false);
                  }
              } else if (aiType === 'gourmet') {
                  const prompt = `Recommend 3 restaurants in ${aiInput1} serving ${aiInput2}. Return JSON array: [{"name":"Name","location":"Area","note":"Why"}]`;
                  const resultText = await callGeminiAPI(prompt);
                  const newItems = JSON.parse(resultText.replace(/```json|```/g, '').trim());
                  if(Array.isArray(newItems)) {
                      setGourmetList([...gourmetList, ...newItems.map(i=>({...i, id: Date.now()+Math.random(), city: aiInput1, photo: null}))]);
                      alert('ÁæéÈ£üÊé®Ëñ¶Â∑≤Âä†ÂÖ•ÔºÅ'); setShowAIModal(false);
                  }
              }
          } catch(e) { console.error(e); alert('AI ÁîüÊàêÂ§±Êïó'); } finally { setIsGenerating(false); }
      };

      const triggerFileAction = (type, id = null) => { setScanType(type); setTargetDayId(id); fileInputRef.current.click(); };
      const addDay = () => { const newId = Date.now(); let nextDate = new Date(); if (itinerary.length > 0) { const lastDate = new Date(itinerary[itinerary.length - 1].date); lastDate.setDate(lastDate.getDate() + 1); nextDate = lastDate; } else if (budgetSettings.startDate) { nextDate = new Date(budgetSettings.startDate); } const dateStr = nextDate.toISOString().split('T')[0]; const newDay = { id: newId, date: dateStr, weekday: getWeekday(dateStr), content: '', transport: '', stay: '', food: '', highlights: '', photo: null, schedule: [] }; setItinerary([...itinerary, newDay]); setTimeout(() => scrollToDay(itinerary.length), 100); };
      const removeDay = (id) => { if(confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄô‰∏ÄÂ§©ÂóéÔºü')) setItinerary(itinerary.filter(d => d.id !== id)); };
      
      const updateItinerary = (id, field, value) => { setItinerary(itinerary.map(item => item.id === id ? { ...item, [field]: value } : item)); };
      const addScheduleItem = (dayId) => { const newScheduleItem = { id: Date.now(), time: '09:00', category: 'ÊôØÈªû', activity: '', note: '' }; setItinerary(itinerary.map(day => day.id === dayId ? { ...day, schedule: [...(day.schedule || []), newScheduleItem] } : day)); };
      const updateScheduleItem = (dayId, itemId, field, value) => { setItinerary(itinerary.map(day => day.id === dayId ? { ...day, schedule: day.schedule.map(item => item.id === itemId ? { ...item, [field]: value } : item) } : day)); };
      const removeScheduleItem = (dayId, itemId) => { if(!confirm('Âà™Èô§Ê≠§Ë°åÁ®ãÁØÄÈªûÔºü')) return; setItinerary(itinerary.map(day => day.id === dayId ? { ...day, schedule: day.schedule.filter(item => item.id !== itemId) } : day)); };
      const moveScheduleItem = (dayId, itemId, direction) => { const dayIndex = itinerary.findIndex(d => d.id === dayId); if (dayIndex === -1) return; const day = itinerary[dayIndex]; const itemIndex = day.schedule.findIndex(i => i.id === itemId); if (itemIndex === -1) return; const newSchedule = [...day.schedule]; if (direction === 'up' && itemIndex > 0) { [newSchedule[itemIndex], newSchedule[itemIndex - 1]] = [newSchedule[itemIndex - 1], newSchedule[itemIndex]]; } else if (direction === 'down' && itemIndex < newSchedule.length - 1) { [newSchedule[itemIndex], newSchedule[itemIndex + 1]] = [newSchedule[itemIndex + 1], newSchedule[itemIndex]]; } const newItinerary = [...itinerary]; newItinerary[dayIndex] = { ...day, schedule: newSchedule }; setItinerary(newItinerary); };

      const mapScheduleCategoryToExpense = (scheduleCat) => {
          if (scheduleCat === 'ÂêÉÈ£Ø') return 'üçú È£≤È£ü';
          if (scheduleCat === '‰∫§ÈÄö') return 'üöÉ ‰∫§ÈÄö';
          if (scheduleCat === 'ÈÄõË°ó') return 'üõçÔ∏è Ë≥ºÁâ©';
          if (scheduleCat === '‰ΩèÂÆø') return 'üè® ‰ΩèÂÆø';
          if (scheduleCat === 'ÊôØÈªû') return 'üé´ ÈñÄÁ•®';
          return 'üìù ÂÖ∂‰ªñ';
      };

      const linkScheduleToExpense = (dayId, itemId) => {
          const day = itinerary.find(d => d.id === dayId);
          const item = day.schedule.find(i => i.id === itemId);

          if (item.expenseId) { 
              if(confirm('‚ö†Ô∏è Ê≠§Ë°åÁ®ãÂ∑≤Ë®òÂ∏≥ÔºåË¶ÅÂà™Èô§Ë©≤Á≠ÜÂ∏≥ÁõÆÂóéÔºü')) {
                  setExpenses(expenses.filter(e => e.id !== item.expenseId)); 
                  updateScheduleItem(dayId, itemId, 'expenseId', null); 
              }
              return; 
          }

          setNewExpense({
              id: Date.now(), 
              date: day.date,
              item: item.activity,
              amount: '',
              currency: 'JPY',
              category: mapScheduleCategoryToExpense(item.category),
              method: paymentMethods[0],
              platform: bookingPlatforms[0], 
              note: item.note,
              source: 'itinerary',
              sourceDayId: dayId,
              sourceScheduleId: itemId
          });
          setShowExpenseModal(true);
      };

      const handleEditExpense = (expense) => {
          setNewExpense({ ...expense });
          setEditingExpenseId(expense.id);
          setShowExpenseModal(true);
      }

      const handleDirectAddExpense = () => { if (!newExpense.item || !newExpense.amount) return; setExpenses([...expenses, { id: Date.now(), ...newExpense, amount: parseFloat(newExpense.amount) }]); setNewExpense({ ...newExpense, item: '', amount: '' }); };
      
      const handleSaveExpense = () => { 
          if (!newExpense.item || !newExpense.amount) return; 
          
          if (editingExpenseId) {
              setExpenses(expenses.map(e => e.id === editingExpenseId ? { ...newExpense, id: editingExpenseId, amount: parseFloat(newExpense.amount) } : e));
              setEditingExpenseId(null);
          } else {
              const expenseId = Date.now();
              const expenseEntry = { ...newExpense, id: expenseId, amount: parseFloat(newExpense.amount) };
              setExpenses([...expenses, expenseEntry]);
              if (newExpense.source === 'itinerary' && newExpense.sourceDayId && newExpense.sourceScheduleId) {
                  updateScheduleItem(newExpense.sourceDayId, newExpense.sourceScheduleId, 'expenseId', expenseId);
              }
          }

          setNewExpense({ date: itinerary[0]?.date || '', item: '', amount: '', currency: 'JPY', category: 'üçú È£≤È£ü', method: paymentMethods[0], platform: bookingPlatforms[0], note: '', source: null, sourceDayId: null, sourceScheduleId: null }); 
          setShowExpenseModal(false); 
      };

      const handleDeleteExpense = (id) => { 
        if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜË®òÈåÑÂóéÔºü')) {
            setExpenses(expenses.filter(e => e.id !== id));
            const linkedShopItem = shoppingList.find(s => s.expenseId === id);
            if(linkedShopItem) setShoppingList(shoppingList.map(s => s.id === linkedShopItem.id ? { ...s, bought: false, expenseId: null } : s));
            setItinerary(itinerary.map(day => ({ ...day, schedule: day.schedule.map(s => s.expenseId === id ? { ...s, expenseId: null } : s) })));
        }
      };

      const handleAddShoppingItem = () => { if (!newShopItem.item) return; setShoppingList([...shoppingList, { id: Date.now(), ...newShopItem, budget: parseFloat(newShopItem.budget) || 0, splitCount: parseInt(newShopItem.splitCount) || 1, bought: false }]); setNewShopItem({ item: '', budget: '', store: '', priority: 'high', type: 'self', note: '', splitCount: 1 }); };
      const handleShoppingItemClick = (item) => { if (item.bought) { toggleShoppingItem(item.id, null); } else { setTempBuyId(item.id); setTempBuyDate(budgetSettings.startDate || new Date().toISOString().split('T')[0]); setShowBuyDateModal(true); } };
      const confirmBuyItem = () => { if (tempBuyId && tempBuyDate) { toggleShoppingItem(tempBuyId, tempBuyDate); setShowBuyDateModal(false); setTempBuyId(null); } };
      const toggleShoppingItem = (id, selectedDate) => {
          const item = shoppingList.find(i => i.id === id); if (!item) return;
          const isBuying = !item.bought; 
          let newExpenseId = item.expenseId;
          let updatedExpenses = [...expenses];
          if (isBuying && selectedDate) {
              newExpenseId = Date.now(); 
              updatedExpenses.push({ id: newExpenseId, date: selectedDate, item: item.item, amount: item.budget, currency: 'JPY', category: 'üõçÔ∏è Ë≥ºÁâ©', method: paymentMethods[0], source: 'shopping', sourceId: id, note: `[Êà∞Âà©ÂìÅÈÄ£Âãï] ${item.type === 'agent' ? '‰ª£Ë≥º: '+item.note : ''}` });
              alert(`‚úÖ Â∑≤Ëá™ÂãïÂä†ÂÖ•Ë®òÂ∏≥ÔºÅ`);
          } else if (newExpenseId) { updatedExpenses = updatedExpenses.filter(e => e.id !== newExpenseId); newExpenseId = null; }
          setExpenses(updatedExpenses);
          setShoppingList(shoppingList.map(i => i.id === id ? { ...i, bought: isBuying, expenseId: newExpenseId } : i));
      };
      const deleteShoppingItem = (id) => { if (confirm('Á¢∫ÂÆöÂà™Èô§Ôºü')) setShoppingList(shoppingList.filter(i => i.id !== id)); };

      const togglePackingItem = (id) => setPackingList(packingList.map(item => item.id === id ? { ...item, checked: !item.checked } : item));
      const addPackingItemToCategory = (category) => { if(!newPackingItemText) return; setPackingList([...packingList, { id: Date.now(), category: category, item: newPackingItemText, checked: false }]); setNewPackingItemText(''); setActivePackingCategory(null); };
      const deletePackingItem = (id) => setPackingList(packingList.filter(i => i.id !== id));
      const addPackingCategory = () => { if(newCategoryName && !packingCategories.includes(newCategoryName)) { setPackingCategories([...packingCategories, newCategoryName]); setNewCategoryName(''); }};
      const deletePackingCategory = (category) => { if(confirm(`Á¢∫ÂÆöÂà™Èô§„Äå${category}„ÄçÔºü`)) { setPackingCategories(packingCategories.filter(c => c !== category)); setPackingList(packingList.filter(item => item.category !== category)); }};
      
      const updateItineraryDates = () => { if (!budgetSettings.startDate) return; const start = new Date(budgetSettings.startDate); const newItinerary = itinerary.map((item, index) => { const d = new Date(start); d.setDate(start.getDate() + index); return { ...item, date: d.toISOString().split('T')[0], weekday: getWeekday(d.toISOString().split('T')[0]) }; }); setItinerary(newItinerary); alert('Ë°åÁ®ãÊó•ÊúüÂ∑≤ÂÖ®ÈÉ®Êõ¥Êñ∞ÔºÅ'); };

      const handleRestore = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                if(data.itinerary) setItinerary(data.itinerary);
                if(data.expenses) setExpenses(data.expenses);
                if(data.shoppingList) setShoppingList(data.shoppingList);
                if(data.packingList) setPackingList(data.packingList);
                if(data.gourmetList) setGourmetList(data.gourmetList);
                if(data.budgetSettings) setBudgetSettings(data.budgetSettings);
                if(data.paymentMethods) setPaymentMethods(data.paymentMethods);
                if(data.bookingPlatforms) setBookingPlatforms(data.bookingPlatforms);
                alert("Ë≥áÊñôÂ∑≤ÊàêÂäüÈÇÑÂéüÔºÅ");
            } catch (error) {
                console.error(error);
                alert("ÂÇô‰ªΩÊ™îÊ†ºÂºèÈåØË™§ÔºÅ");
            }
        };
        reader.readAsText(file);
      };

      const exportToExcel = () => {
        const wb = XLSX.utils.book_new();
        const wsExpenses = XLSX.utils.json_to_sheet(expenses.map(e => ({ Date: e.date, Item: e.item, Amount: e.amount, Currency: e.currency, Category: e.category, Method: e.method, Note: e.note })));
        XLSX.utils.book_append_sheet(wb, wsExpenses, "Expenses");
        const wsShopping = XLSX.utils.json_to_sheet(shoppingList.map(s => ({ Item: s.item, Budget: s.budget, Bought: s.bought ? "Yes" : "No", Type: s.type })));
        XLSX.utils.book_append_sheet(wb, wsShopping, "Shopping");
        XLSX.writeFile(wb, "Travel_Plan_2026.xlsx");
        setShowExportModal(false);
      };

      // Word Export Feature
      const exportToWord = () => {
          let htmlContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'><title>2026Â§ßÈóúË•øÊï£Á≠ñ</title>
            <style>
              body { font-family: 'Microsoft JhengHei', sans-serif; }
              h1 { color: #F48FB1; text-align: center; }
              h2 { background: #eee; padding: 5px; border-left: 5px solid #F48FB1; }
              table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #f2f2f2; }
            </style>
            </head><body>
            <h1>2026Â§ßÈóúË•øÊï£Á≠ñ - ÊóÖÈÅäÊâãÂ∏≥</h1>
          `;

          // Itinerary
          itinerary.forEach(day => {
              htmlContent += `<h2>${formatDate(day.date)} (${getWeekday(day.date)}) - ${day.transport}</h2>`;
              htmlContent += `<table><thead><tr><th width="15%">ÊôÇÈñì</th><th width="30%">Ê¥ªÂãï</th><th>ÂÇôË®ª</th></tr></thead><tbody>`;
              day.schedule.forEach(item => {
                  htmlContent += `<tr><td>${item.time}</td><td>${item.activity}</td><td>${item.note}</td></tr>`;
              });
              htmlContent += `</tbody></table>`;
          });

          // Accommodations
          if (accommodations.length > 0) {
              htmlContent += `<h2>üè® ‰ΩèÂÆøË≥áË®ä</h2>`;
              accommodations.forEach(h => {
                  htmlContent += `<p><strong>${h.name}</strong><br/>Âú∞ÂùÄ: ${h.address}<br/>ÂÇôË®ª: ${h.note}</p><hr/>`;
              });
          }

          htmlContent += `</body></html>`;

          const blob = new Blob(['\ufeff', htmlContent], {
              type: 'application/msword'
          });
          
          // Create download link
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'Travel_Booklet_2026.doc';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      };

      const handleAddHotel = () => { if(!newHotel.name) return; setAccommodations([...accommodations, { id: Date.now(), ...newHotel }]); setNewHotel({ name: '', address: '', note: '', date: budgetSettings.startDate || '' }); setShowAddHotel(false); };
      const handleDeleteHotel = (id) => setAccommodations(accommodations.filter(a => a.id !== id));
      const handleAddReserv = () => { if(!newReserv.title) return; setReservations([...reservations, { id: Date.now(), ...newReserv }]); setNewReserv({ title: '', time: '', code: '' }); setShowAddReserv(false); };
      const handleDeleteReserv = (id) => setReservations(reservations.filter(r => r.id !== id));
      const handleAddGourmet = () => { if(!newGourmet.name) return; setGourmetList([...gourmetList, { id: Date.now(), ...newGourmet }]); setNewGourmet({ name: '', city: 'Â§ßÈò™', location: '', photo: null, note: '' }); setShowAddGourmet(false); };
      const handleDeleteGourmet = (id) => setGourmetList(gourmetList.filter(g => g.id !== id));

      const handleBatchImport = () => {
          if (!batchText) return;
          const lines = batchText.split('\n').map(l => l.trim()).filter(l => l);
          if (batchType === 'packing') { setPackingList([...packingList, ...lines.map(l => ({ id: Date.now() + Math.random(), category: 'Êú™ÂàÜÈ°û', item: l, checked: false }))]); } 
          else if (batchType === 'shopping') { setShoppingList([...shoppingList, ...lines.map(l => ({ id: Date.now() + Math.random(), item: l, budget: 0, bought: false, store: '', priority: 'medium', type: 'self', note: '', splitCount: 1 }))]); }
          setBatchText(''); setShowBatchModal(false);
      };

      const BuyDateModal = () => (
          <div className="fixed inset-0 z-[70] flex items-center justify-center modal-backdrop" onClick={() => setShowBuyDateModal(false)}>
              <div className="bg-white w-[95%] max-w-sm p-5 fade-in shadow-2xl ticket-box" onClick={e => e.stopPropagation()}>
                  <h3 className="font-bold text-2xl text-gray-800 mb-4 text-center">üìÖ ‰ªÄÈ∫ºÊôÇÂÄôË≤∑ÁöÑÔºü</h3>
                  <div className="mb-4"><label className="text-sm font-bold text-gray-500 ml-1">ÈÅ∏ÊìáË≥ºË≤∑Êó•Êúü</label><input type="date" value={tempBuyDate} onChange={e => setTempBuyDate(e.target.value)} className="w-full p-3 outline-none font-bold text-2xl text-center text-[#F48FB1] dashed-input"/></div>
                  <button onClick={confirmBuyItem} className="w-full bg-[#F48FB1] text-white py-3 font-bold text-xl shadow-lg active:scale-95 transition-transform rounded-xl">Á¢∫Ë™çË®òÂ∏≥</button>
              </div>
          </div>
      );

      const SettingsModal = () => {
          const [newMethodName, setNewMethodName] = useState('');
          const [newPlatformName, setNewPlatformName] = useState('');
          const addMethod = () => { if(newMethodName && !paymentMethods.includes(newMethodName)) { setPaymentMethods([...paymentMethods, newMethodName]); setNewMethodName(''); } };
          const removeMethod = (m) => { if(confirm('Âà™Èô§Ê≠§ÊîØ‰ªòÊñπÂºèÔºü')) setPaymentMethods(paymentMethods.filter(item => item !== m)); };
          const addPlatform = () => { if(newPlatformName && !bookingPlatforms.includes(newPlatformName)) { setBookingPlatforms([...bookingPlatforms, newPlatformName]); setNewPlatformName(''); } };
          const removePlatform = (p) => { if(confirm('Âà™Èô§Ê≠§È†êË®ÇÂπ≥Âè∞Ôºü')) setBookingPlatforms(bookingPlatforms.filter(item => item !== p)); };

          return (
            <div className="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop" onClick={() => setShowSettingsModal(false)}>
                <div className="bg-white w-[95%] max-w-sm p-5 fade-in max-h-[85vh] overflow-y-auto ticket-box" onClick={e => e.stopPropagation()}>
                    <h3 className="font-bold text-2xl text-gray-800 mb-4 text-center">‚öôÔ∏è Ë®≠ÂÆö</h3>
                    <div className="space-y-3 mb-6">
                        <div><label className="text-xs font-bold text-gray-500">Âá∫ÁôºÊó•Êúü</label><input type="date" value={budgetSettings.startDate} onChange={e => setBudgetSettings({...budgetSettings, startDate: e.target.value})} className="w-full bg-gray-100 p-2 font-bold text-lg dashed-input" /><button onClick={updateItineraryDates} className="mt-1 text-xs text-blue-500 font-bold underline">ÂêåÊ≠•Êõ¥Êñ∞Ë°åÁ®ãÊó•Êúü</button></div>
                        <div><label className="text-xs font-bold text-gray-500">Á∏ΩÈ†êÁÆó (TWD)</label><input type="number" value={budgetSettings.totalTWD} onChange={e => setBudgetSettings({...budgetSettings, totalTWD: parseInt(e.target.value)})} className="w-full bg-gray-100 p-2 font-bold text-lg dashed-input" /></div>
                        <div><label className="text-xs font-bold text-gray-500">ÂåØÁéá (JPY to TWD)</label><input type="number" step="0.001" value={budgetSettings.rates.JPY_TWD} onChange={e => setBudgetSettings({...budgetSettings, rates: {...budgetSettings.rates, JPY_TWD: parseFloat(e.target.value)}})} className="w-full bg-gray-100 p-2 font-bold text-lg dashed-input" /></div>
                    </div>
                    
                    <button onClick={() => { setShowSettingsModal(false); setShowBooklet(true); }} className="w-full mb-6 bg-[#2962FF] text-white py-3 font-bold flex justify-center items-center gap-2 rounded-xl shadow-md active:scale-95 transition-transform"><Icons.Book size={20}/> üìñ È†êË¶Ω / ÂåØÂá∫ÊóÖÈÅäÂ∞èÊú¨Êú¨</button>

                    <div className="border-t pt-4 mb-4">
                        <h4 className="font-bold text-gray-700 mb-2 flex items-center gap-1"><Icons.Coins size={18}/> üí≥ ÊîØ‰ªòÊñπÂºèÁÆ°ÁêÜ</h4>
                        <div className="flex gap-2 mb-2"><input value={newMethodName} onChange={e=>setNewMethodName(e.target.value)} placeholder="Â¶Ç: LINE Pay" className="flex-1 bg-gray-50 border px-2 py-1 text-sm dashed-input" /><button onClick={addMethod} className="bg-[#FF9F43] text-white px-3 text-sm font-bold rounded-lg">Êñ∞Â¢û</button></div>
                        <div className="flex flex-wrap gap-2">{paymentMethods.map(m => (<span key={m} className="bg-orange-50 text-orange-600 px-2 py-1 text-xs font-bold border border-orange-200 flex items-center gap-1 rounded-lg">{m} <button onClick={()=>removeMethod(m)} className="hover:text-red-500"><Icons.X size={10}/></button></span>))}</div>
                    </div>
                    <div className="border-t pt-4 mb-6">
                        <h4 className="font-bold text-gray-700 mb-2 flex items-center gap-1"><Icons.Ticket size={18}/> üì± È†êË®ÇÂπ≥Âè∞ÁÆ°ÁêÜ</h4>
                        <div className="flex gap-2 mb-2"><input value={newPlatformName} onChange={e=>setNewPlatformName(e.target.value)} placeholder="Â¶Ç: KKday" className="flex-1 bg-gray-50 border px-2 py-1 text-sm dashed-input" /><button onClick={addPlatform} className="bg-[#4ECDC4] text-white px-3 text-sm font-bold rounded-lg">Êñ∞Â¢û</button></div>
                        <div className="flex flex-wrap gap-2">{bookingPlatforms.map(p => (<span key={p} className="bg-teal-50 text-teal-600 px-2 py-1 text-xs font-bold border border-teal-200 flex items-center gap-1 rounded-lg">{p} <button onClick={()=>removePlatform(p)} className="hover:text-red-500"><Icons.X size={10}/></button></span>))}</div>
                    </div>
                    <div className="flex gap-2">
                        <button onClick={() => { const data = JSON.stringify({ itinerary, expenses, shoppingList, packingList, budgetSettings, paymentMethods, bookingPlatforms }); const blob = new Blob([data], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'backup.json'; a.click(); }} className="flex-1 bg-gray-200 py-2 font-bold text-gray-600 rounded-lg">ÂÇô‰ªΩ</button>
                        <button onClick={() => backupInputRef.current.click()} className="flex-1 bg-gray-200 py-2 font-bold text-gray-600 rounded-lg">ÈÇÑÂéü</button>
                    </div>
                    <button onClick={() => setShowExportModal(true)} className="w-full mt-2 bg-[#207245] text-white py-2 font-bold flex justify-center items-center gap-2 rounded-lg"><Icons.FileSpreadsheet size={16}/> ÂåØÂá∫ Excel</button>
                    <button onClick={() => setShowSettingsModal(false)} className="w-full mt-4 bg-[#F48FB1] text-white py-3 font-bold text-lg rounded-xl shadow-md">ÂÆåÊàê</button>
                </div>
            </div>
          );
      };

      const ExpenseModal = () => {
          const handleCalcConfirm = (val) => {
              setNewExpense(prev => ({ ...prev, amount: val }));
          };

          return (
            <div className="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop" onClick={() => setShowExpenseModal(false)}>
              <div className="bg-white w-[95%] max-w-sm p-5 fade-in ticket-box" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-2xl text-gray-800 mb-4 text-center">{editingExpenseId ? '‚úèÔ∏è ‰øÆÊîπÂ∏≥ÁõÆ' : 'üí∏ Ë®ò‰∏ÄÁ≠Ü'}</h3>
                <div className="space-y-3">
                    <input type="text" placeholder="È†ÖÁõÆ" value={newExpense.item} onChange={e => setNewExpense({...newExpense, item: e.target.value})} className="w-full bg-gray-50 border-b-2 border-gray-200 p-2 font-bold text-lg outline-none dashed-input" />
                    
                    {/* Merged Amount and Currency Input */}
                    <div className="flex items-center w-full dashed-input overflow-hidden px-2 bg-[#FAFAFA]">
                        <input 
                            type="text" 
                            placeholder="ÈáëÈ°ç" 
                            value={newExpense.amount} 
                            readOnly 
                            onClick={() => { setCalcTarget('expense'); setShowCalculator(true); }}
                            className="flex-1 bg-transparent border-none outline-none text-2xl font-black text-[#F57C00] h-12 cursor-pointer text-right pr-2" 
                        />
                        <div className="w-[1px] h-8 bg-gray-300 mx-1"></div>
                        <select 
                            value={newExpense.currency} 
                            onChange={e => setNewExpense({...newExpense, currency: e.target.value})} 
                            className="bg-transparent border-none outline-none font-bold text-lg w-20 text-center text-gray-600 appearance-none h-12"
                        >
                            {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code}</option>)}
                        </select>
                    </div>

                    <div className="flex gap-2"><select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})} className="flex-1 bg-gray-50 p-2 text-sm font-bold dashed-input">{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select><select value={newExpense.method} onChange={e => setNewExpense({...newExpense, method: e.target.value})} className="flex-1 bg-gray-50 p-2 text-sm font-bold dashed-input">{paymentMethods.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                    <div className="flex flex-col gap-1"><label className="text-xs font-bold text-gray-500 ml-1">È†êË®ÇÂπ≥Âè∞ (Â¶ÇÈÅ©Áî®)</label><select value={newExpense.platform} onChange={e => setNewExpense({...newExpense, platform: e.target.value})} className="w-full bg-gray-50 p-2 text-sm font-bold dashed-input"><option value="">ÁÑ° / ÁèæÂ†¥</option>{bookingPlatforms.map(p => <option key={p} value={p}>{p}</option>)}</select></div>
                    <button onClick={handleSaveExpense} className="w-full bg-[#F57C00] text-white py-3 font-bold text-lg shadow-md mt-4 rounded-xl">{editingExpenseId ? 'üíæ ÂÑ≤Â≠ò‰øÆÊîπ' : 'ÂÑ≤Â≠ò'}</button>
                </div>
              </div>
              <CalculatorModal 
                  isOpen={showCalculator && calcTarget === 'expense'} 
                  onClose={() => setShowCalculator(false)} 
                  onConfirm={handleCalcConfirm} 
                  initialValue={newExpense.amount}
              />
            </div>
          );
      };

      const BatchModal = () => (
        <div className="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop" onClick={() => setShowBatchModal(false)}>
            <div className="bg-white w-[95%] max-w-sm p-5 fade-in ticket-box" onClick={e => e.stopPropagation()}>
                <h3 className="font-bold text-xl mb-2">ÊâπÊ¨°ÂåØÂÖ• {batchType === 'packing' ? 'Ë°åÊùé' : 'Ë≥ºÁâ©'} Ê∏ÖÂñÆ</h3>
                <p className="text-xs text-gray-400 mb-2">‰∏ÄË°å‰∏ÄÂÄãÈ†ÖÁõÆ</p>
                <textarea value={batchText} onChange={e => setBatchText(e.target.value)} className="w-full h-40 bg-gray-50 border p-2 mb-4 font-bold dashed-input" placeholder="‰æãÂ¶ÇÔºö&#10;Ë≠∑ÁÖß&#10;ÂÖÖÈõªÂô®"></textarea>
                <button onClick={handleBatchImport} className="w-full bg-blue-500 text-white py-3 font-bold rounded-xl">ÈñãÂßãÂåØÂÖ•</button>
            </div>
        </div>
      );

      const AIModal = () => (
          <div className="fixed inset-0 z-[60] flex items-center justify-center modal-backdrop" onClick={() => setShowAIModal(false)}>
             <div className="bg-white w-[95%] max-w-sm p-5 fade-in ticket-box" onClick={e => e.stopPropagation()}>
                 <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-xl flex items-center gap-2"><Icons.Sparkles size={24} className="text-[#F48FB1]"/> AI Âä©Êâã</h3><button onClick={() => setShowAIModal(false)}><Icons.X size={24}/></button></div>
                 <div className="space-y-4">
                     <div><label className="text-sm font-bold text-gray-500">Âú∞Èªû / ÂüéÂ∏Ç</label><input value={aiInput1} onChange={e => setAiInput1(e.target.value)} className="w-full bg-gray-50 border p-2 font-bold dashed-input" /></div>
                     <div><label className="text-sm font-bold text-gray-500">È¢®Ê†º / ÈóúÈçµÂ≠ó</label><input value={aiInput2} onChange={e => setAiInput2(e.target.value)} className="w-full bg-gray-50 border p-2 font-bold dashed-input" placeholder="‰æãÂ¶Ç: ÊãâÈ∫µ, ÈÄõË°ó, Ê≠∑Âè≤" /></div>
                     <button onClick={handleAIGenerate} disabled={isGenerating} className="w-full bg-[#F48FB1] text-white py-3 font-bold flex justify-center items-center gap-2 shadow-md rounded-xl">{isGenerating ? <Icons.Loader className="loading-spin"/> : <Icons.Sparkles/>} {isGenerating ? 'ÁîüÊàê‰∏≠...' : 'ÈñãÂßãÁîüÊàê'}</button>
                 </div>
             </div>
          </div>
      );

      const TabButton = ({ id, IconComp, label, bgColor, activeColor }) => (
        <button onClick={() => setActiveTab(id)} className={`flex flex-col items-center justify-end h-full transition-all duration-300 ${activeTab === id ? '-translate-y-3' : ''}`}>
            <div className={`p-3 shadow-lg border-2 border-black transition-all ${activeTab === id ? 'scale-110' : 'scale-100 opacity-80'}`} style={{ backgroundColor: activeTab === id ? activeColor : bgColor, color: activeTab === id ? 'white' : '#546E7A', borderRadius: '50%' }}>
                <IconComp size={24} strokeWidth={3} />
            </div>
            <span className={`text-[10px] font-bold mt-1 bg-white/80 px-2 rounded ${activeTab === id ? 'text-gray-800' : 'text-gray-400'}`}>{label}</span>
        </button>
      );

      const FloatingActionButton = () => (
          <div className="absolute bottom-6 right-4 flex flex-col gap-2">
             <button onClick={() => setShowBooklet(true)} className="w-12 h-12 bg-white shadow-lg flex items-center justify-center border-2 border-gray-200 text-gray-600 active:scale-90 transition-transform rounded-full"><Icons.Book size={20}/></button>
          </div>
      );

      const TravelBooklet = () => {
          if (!showBooklet) return null;
          return ReactDOM.createPortal(
            <div className="fixed inset-0 bg-white z-[9999] overflow-y-auto" id="booklet-root">
                <div className="p-8 max-w-4xl mx-auto print:p-0">
                    <div className="flex justify-between items-center mb-8 print-hidden">
                        <div className="flex items-center gap-4">
                            <h1 className="text-xl sm:text-2xl font-bold">üñ®Ô∏è ÂàóÂç∞ / ÂåØÂá∫È†êË¶Ω</h1>
                            <span className="text-[10px] sm:text-sm bg-yellow-100 text-yellow-800 px-2 py-1 rounded">üí° Â∞èÊèêÁ§∫ÔºöÈªûÊìä‰∏ãÊñπÊñáÂ≠óÂèØÁõ¥Êé•‰øÆÊîπÂÖßÂÆπÔºÅ</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={exportToWord} className="bg-[#2962FF] text-white px-3 py-2 rounded-lg font-bold flex items-center gap-1 text-sm"><Icons.Word size={16}/> ‰∏ãËºâ Word</button>
                            <button onClick={() => window.print()} className="bg-[#455A64] text-white px-3 py-2 rounded-lg font-bold flex items-center gap-1 text-sm"><Icons.Printer size={16}/> ÂàóÂç∞</button>
                            <button onClick={() => setShowBooklet(false)} className="bg-gray-200 px-3 py-2 rounded-lg font-bold text-sm">ÈóúÈñâ</button>
                        </div>
                    </div>
                    <div className="border-4 border-black p-4 sm:p-8 mb-8 text-center bg-[#FCE4EC] rounded-3xl avoid-break ticket-box">
                        <h1 className="text-4xl sm:text-6xl font-black mb-4 tracking-widest text-[#880E4F]" contentEditable suppressContentEditableWarning>2026<br/>Â§ßÈóúË•øÊï£Á≠ñ</h1>
                        <div className="text-xl sm:text-2xl font-bold text-gray-600" contentEditable suppressContentEditableWarning>TRAVEL ITINERARY</div>
                    </div>
                    {itinerary.map((day) => (
                        <div key={day.id} className="mb-8 avoid-break border-2 border-gray-200 p-3 sm:p-4 ticket-box">
                            <h2 className="text-2xl sm:text-3xl font-bold mb-4 border-b-2 border-black pb-2 flex justify-between flex-wrap">
                                <span contentEditable suppressContentEditableWarning>{formatDate(day.date)} <small>({getWeekday(day.date)})</small></span>
                                <span className="text-base sm:text-lg text-gray-500" contentEditable suppressContentEditableWarning>{day.transport}</span>
                            </h2>
                            <table className="w-full text-left">
                                <thead><tr className="border-b"><th className="pb-2 w-16 sm:w-20 text-sm sm:text-base">ÊôÇÈñì</th><th className="pb-2 text-sm sm:text-base">Ê¥ªÂãï</th><th className="pb-2 text-sm sm:text-base">ÂÇôË®ª</th></tr></thead>
                                <tbody>
                                    {day.schedule.map(s => (
                                        <tr key={s.id} className="border-b border-dashed border-gray-200">
                                            <td className="py-2 font-mono font-bold text-sm sm:text-base" contentEditable suppressContentEditableWarning>{s.time}</td>
                                            <td className="py-2 font-bold text-sm sm:text-base" contentEditable suppressContentEditableWarning>{s.activity}</td>
                                            <td className="py-2 text-xs sm:text-sm text-gray-500" contentEditable suppressContentEditableWarning>{s.note}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ))}
                    <div className="page-break"></div>
                    <div className="avoid-break">
                        <h2 className="text-3xl font-bold mb-4 border-b-2 border-black pb-2">‰ΩèÂÆøË≥áË®ä</h2>
                        {accommodations.map(h => (
                            <div key={h.id} className="mb-4 border p-2 rounded ticket-box">
                                <div className="font-bold text-xl" contentEditable suppressContentEditableWarning>{h.name}</div>
                                <div className="text-sm" contentEditable suppressContentEditableWarning>{h.address}</div>
                                <div className="text-sm text-gray-500" contentEditable suppressContentEditableWarning>{h.note}</div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>,
            document.body
          );
      };

      return (
        <div className="flex flex-col h-full bg-white w-full max-w-4xl mx-auto shadow-2xl overflow-hidden relative font-sans text-gray-900">
          {showBooklet && <TravelBooklet />}
          {showAIModal && <AIModal />}
          {showBuyDateModal && <BuyDateModal />}
          {showSettingsModal && <SettingsModal />}
          {showExpenseModal && <ExpenseModal />}
          {showExportModal && <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop" onClick={() => setShowExportModal(false)}><div className="bg-white w-[95%] max-w-sm p-6 fade-in ticket-box" onClick={e => e.stopPropagation()}><h3 className="font-bold text-2xl text-gray-800 mb-4 text-center">üìä ÂåØÂá∫ Excel</h3><button onClick={exportToExcel} className="w-full bg-[#207245] text-white font-bold text-xl py-4 border-2 border-black flex justify-center items-center gap-2 mb-2 rounded-xl"><Icons.FileSpreadsheet size={24} /> ‰∏ãËºâÂ†±Ë°®</button><button onClick={() => setShowExportModal(false)} className="w-full text-gray-500 font-bold py-3 text-lg">ÂèñÊ∂à</button></div></div>}
          {showBatchModal && <BatchModal />}
          {isScanning && <div className="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/90 text-white"><Icons.Loader size={60} className="loading-spin mb-4 text-[#F48FB1]" /><div className="text-3xl font-bold animate-pulse">ËôïÁêÜ‰∏≠...</div></div>}
          <input type="file" accept="image/*" ref={fileInputRef} onChange={handleFileSelect} className="hidden" />
          <input type="file" accept=".json" ref={backupInputRef} onChange={handleRestore} className="hidden" />

          <div className="safe-area-top"></div>
          <div className="bg-[#F48FB1] px-4 py-2 relative overflow-hidden border-b-2 border-black shrink-0 z-50">
            <div className="flex justify-between items-center"><h1 className="text-xl sm:text-2xl font-bold text-white tracking-widest flex items-center gap-2"><span>‚õÑ‚ùÑÔ∏è‚õ©Ô∏è</span> 2026Â§ßÈóúË•ø‚ùÑÔ∏èÊï£Á≠ñ</h1><div className="flex items-center gap-3"><WeatherWidget /><button onClick={() => setShowSettingsModal(true)} className="text-white hover:text-gray-100 bg-white/20 p-1.5 rounded-full"><Icons.Settings size={24} /></button></div></div>
          </div>

          <div className="flex-1 overflow-hidden relative bg-[#E0F7FA]">
            {activeTab === 'itinerary' && (
              <div className="h-full flex flex-col p-4">
                <div className="flex gap-3 overflow-x-auto no-scrollbar mb-3 shrink-0 py-1">
                  {(itinerary || []).map((day, index) => (<button key={day.id} onClick={() => scrollToDay(index)} className={`shrink-0 w-12 h-12 font-bold text-lg border-2 border-black shadow-md flex items-center justify-center transition-all ${currentDayIndex === index ? 'scale-110 ring-2 ring-black' : 'opacity-70'}`} style={{ backgroundColor: BUTTON_COLORS[index % BUTTON_COLORS.length], color: 'white', borderRadius: '50%' }}>{formatDate(day.date)}</button>))}
                  <button onClick={addDay} className="shrink-0 w-12 h-12 bg-white border-2 border-dashed border-gray-400 flex items-center justify-center text-gray-400 hover:text-[#F48FB1] rounded-full"><Icons.Plus size={24}/></button>
                </div>
                <div ref={dayScrollRef} className="flex-1 flex overflow-x-auto snap-x-mandatory no-scrollbar gap-4 h-full" onScroll={(e) => { const index = Math.round(e.target.scrollLeft / e.target.offsetWidth); setCurrentDayIndex(index); }}>
                    {(itinerary || []).map((day, index) => {
                        const dayTotal = getDailyTotal(day.date);
                        return (
                            <div key={day.id} className="w-full shrink-0 snap-center flex flex-col h-full">
                                <div className="bg-white border-2 border-black shadow-xl flex flex-col relative h-full overflow-hidden ticket-box">
                                    <div className="bg-[#FFF8E1] border-b-2 border-dashed border-gray-300 p-3 flex justify-between items-center shrink-0">
                                        <div className="flex items-center gap-2"><span className="font-black text-2xl sm:text-3xl text-gray-800">{formatDate(day.date)}</span><span className="text-lg sm:text-xl font-bold text-gray-400">({getWeekday(day.date)})</span></div>
                                        <div className="flex gap-2">
                                            <button onClick={() => openAIPlanner(day.id)} className="p-2 sparkle-btn shadow active:translate-y-1 flex items-center gap-1 font-bold text-xs rounded-xl"><Icons.Sparkles size={16}/> AI</button>
                                            <button onClick={() => triggerFileAction('itineraryImport', day.id)} className="p-2 bg-[#B2DFDB] text-[#00695C] border border-black shadow active:translate-y-1 flex items-center gap-1 font-bold text-xs rounded-xl"><Icons.ListPlus size={16}/> ÂåØÂÖ•</button>
                                            <button onClick={() => triggerFileAction('itinerary', day.id)} className="p-2 bg-[#E1BEE7] text-[#9C27B0] border border-black shadow active:translate-y-1 rounded-full"><Icons.Camera size={18}/></button>
                                            <button onClick={() => removeDay(day.id)} className="p-2 bg-gray-100 text-gray-500 border border-gray-300 hover:text-red-500 rounded-lg"><Icons.Trash2 size={18}/></button>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto no-scrollbar p-4 space-y-4 paper-texture">
                                        <div className="bg-white/90 p-3 border-2 border-gray-100 shadow-sm ticket-box">
                                            <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2 text-[#0097A7] font-bold text-lg"><Icons.Clock size={24}/> Ë©≥Á¥∞Ë°åÁ®ã</div><button onClick={() => addScheduleItem(day.id)} className="text-[#0097A7] bg-[#E0F7FA] px-2 py-1 text-sm font-bold border border-[#B2EBF2] rounded-lg">+ Êñ∞Â¢û</button></div>
                                            <div className="space-y-4 mt-4">
                                                {day.schedule && day.schedule.map(item => (
                                                    <div key={item.id} className={`relative flex gap-2 items-start bg-white p-3 border border-gray-300 transition-all rounded-lg ${editingScheduleId === item.id ? 'scale-105 shadow-lg border-[#F48FB1] bg-red-50 z-10' : ''}`} onTouchStart={() => { const t = setTimeout(() => setEditingScheduleId(item.id), 500); item.timer = t; }} onTouchEnd={() => clearTimeout(item.timer)} onMouseDown={() => { const t = setTimeout(() => setEditingScheduleId(item.id), 500); item.timer = t; }} onMouseUp={() => clearTimeout(item.timer)}>
                                                    <div className="washi-tape"></div>
                                                    <div className="flex flex-col gap-1 items-center shrink-0">
                                                        <input value={item.time} onChange={(e) => updateScheduleItem(day.id, item.id, 'time', e.target.value)} className="w-14 bg-white border border-gray-300 p-1 text-sm font-bold text-center outline-none rounded" type="time" />
                                                        {editingScheduleId === item.id && (<div className="flex flex-col gap-1 mt-1"><button onClick={() => moveScheduleItem(day.id, item.id, 'up')} className="bg-gray-200 p-1 rounded hover:bg-gray-300"><Icons.ArrowUp size={12}/></button><button onClick={() => moveScheduleItem(day.id, item.id, 'down')} className="bg-gray-200 p-1 rounded hover:bg-gray-300"><Icons.ArrowDown size={12}/></button><button onClick={() => setEditingScheduleId(null)} className="text-[10px] text-blue-500 font-bold">ÂÆåÊàê</button></div>)}
                                                    </div>
                                                    <div className="flex-1 flex flex-col gap-2 min-w-0">
                                                        <div className="flex gap-2">
                                                            <select value={item.category} onChange={(e) => updateScheduleItem(day.id, item.id, 'category', e.target.value)} className="bg-white border border-gray-300 p-1 text-xs font-bold w-20 outline-none shrink-0 rounded">{SCHEDULE_CATEGORIES.map(c => <option key={c.name} value={c.name}>{c.name}</option>)}</select>
                                                            <input value={item.activity} onChange={(e) => updateScheduleItem(day.id, item.id, 'activity', e.target.value)} className="flex-1 bg-transparent border-b-2 border-dashed border-gray-300 outline-none text-base font-bold text-gray-800 min-w-0" placeholder="ÂÅö‰ªÄÈ∫º..." />
                                                        </div>
                                                        <div className="flex gap-2 items-center">
                                                            <input value={item.note} onChange={(e) => updateScheduleItem(day.id, item.id, 'note', e.target.value)} className="flex-1 bg-transparent outline-none text-xs text-gray-500 bg-white/50 px-1 min-w-0 rounded" placeholder="ÂÇôË®ª..." />
                                                            {/* Enhanced Expense Button Logic */}
                                                            {item.expenseId ? (
                                                                <div className="stamp-animation border-2 border-red-500 text-red-500 text-[10px] font-black px-1 transform -rotate-12 rounded opacity-80 cursor-pointer hover:bg-red-50" onClick={(e) => { e.stopPropagation(); linkScheduleToExpense(day.id, item.id); }}>
                                                                    PAID
                                                                </div>
                                                            ) : (
                                                                <button onClick={(e) => { e.stopPropagation(); linkScheduleToExpense(day.id, item.id); }} className="bg-[#FFF3E0] text-[#E65100] border border-[#FFE0B2] px-2 py-1 rounded text-xs font-bold shadow-sm hover:bg-[#FFE0B2] flex items-center gap-1 active:scale-95 transition-transform shrink-0">
                                                                    <Icons.Coins size={14}/> Ë®òÂ∏≥
                                                                </button>
                                                            )}
                                                            <button onClick={() => removeScheduleItem(day.id, item.id)} className="text-gray-300 hover:text-red-400 shrink-0"><Icons.Trash2 size={16}/></button>
                                                        </div>
                                                    </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex gap-3"><div className="flex-1 bg-white/90 p-2 border-2 border-gray-100 shadow-sm rounded-xl"><div className="flex items-center gap-1 text-[#455A64] font-bold text-sm mb-1"><Icons.Train size={18}/> ‰∫§ÈÄö</div><input value={day.transport} onChange={(e) => updateItinerary(day.id, 'transport', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="Êê≠Ëªä..." /></div><div className="flex-1 bg-white/90 p-2 border-2 border-gray-100 shadow-sm rounded-xl"><div className="flex items-center gap-1 text-[#5C6BC0] font-bold text-sm mb-1"><Icons.Home size={18}/> ‰ΩèÂÆø</div><input value={day.stay} onChange={(e) => updateItinerary(day.id, 'stay', e.target.value)} className="w-full bg-transparent p-1 text-base font-bold outline-none text-gray-700" placeholder="È£ØÂ∫ó..." /></div></div>
                                        <div className="bg-[#FFF8E1] p-3 border-2 border-[#FFE0B2] shadow-sm ticket-box">
                                            <div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2 text-[#F57C00] font-bold text-lg"><Icons.Coins size={22}/> Êú¨Êó•Â∏≥Êú¨</div><span className="text-sm font-black text-[#F57C00]">${dayTotal.toLocaleString()}</span></div>
                                            <div className="space-y-1 mb-2">{expenses.filter(e => e.date === day.date).map(e => (<div key={e.id} className="flex justify-between text-xs text-gray-600 border-b border-dashed border-gray-300 pb-1"><span>{e.item}</span><span className="font-bold">{CURRENCIES.find(c => c.code === e.currency)?.symbol}{e.amount}</span></div>))}</div>
                                            <button onClick={() => { setNewExpense({...newExpense, date: day.date}); setShowExpenseModal(true); }} className="w-full bg-[#FF9F43] text-white py-2 font-bold text-sm shadow-sm active:scale-95 transition-transform rounded-xl">+ Ë®ò‰∏ÄÁ≠Ü</button>
                                        </div>
                                        <div className="pt-1"><div className="flex items-center gap-2 text-gray-500 font-bold text-sm mb-2"><Icons.Camera size={18}/> ÊâìÂç° / ÁÖßÁâáÊó•Ë®ò</div><div onClick={() => triggerFileAction('photo', day.id)} className="w-full h-40 border-4 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:bg-white/50 overflow-hidden relative bg-white/30 group transition-all rounded-xl">{day.photo ? <img src={day.photo} alt="Daily" className="w-full h-full object-cover" /> : <div className="flex flex-col items-center text-gray-400 group-hover:text-[#F48FB1] transition-colors"><Icons.Image size={32}/><span className="text-xs font-bold mt-1">ÈªûÊìä‰∏äÂÇ≥</span></div>}</div></div>
                                    </div>
                                    <div className="p-3 border-t-2 border-gray-100 bg-gray-50 flex justify-between items-center shrink-0"><button onClick={(e) => openGoogleMaps(e, day.content)} className="w-full bg-[#E0F7FA] text-[#00BCD4] px-4 py-2 font-bold text-sm flex items-center justify-center gap-1 hover:bg-[#B2EBF2] border border-[#B2EBF2] rounded-xl"><Icons.Navigation size={16}/> Google Maps Â∞éËà™</button></div>
                                </div>
                            </div>
                        );
                    })}
                </div>
                <FloatingActionButton />
              </div>
            )}

            {/* Expenses Tab */}
            {activeTab === 'expenses' && (
              <div className="h-full flex flex-col pt-4 overflow-hidden relative">
                <div className="px-4 pb-2"><div className="bg-[#FFF8E1] p-3 border-2 border-[#FFE0B2] shadow-sm flex justify-between items-center ticket-box"><div><div className="text-xs text-[#F57C00] font-bold">Á∏ΩËä±Ë≤ª (Âè∞Âπ£)</div><div className="text-2xl font-black text-[#E65100]">${totalSpentConvertedTWD.toLocaleString()}</div></div><div className="text-right"><div className="text-xs text-[#F57C00] font-bold">Á¥ÑÂêàÊó•Âπ£</div><div className="text-xl font-black text-[#FF9800]">¬•{Math.round(totalSpentConvertedTWD / getExchangeRate('JPY')).toLocaleString()}</div></div></div></div>
                <div className="px-4 mb-2">
                    <div className="bg-white shadow-md border-2 border-[#F48FB1] p-3 rounded-2xl">
                        <div className="mb-2"><select value={newExpense.date} onChange={e => setNewExpense({...newExpense, date: e.target.value})} className="w-full bg-gray-50 p-2 outline-none text-sm font-bold border border-gray-200 dashed-input">{(itinerary || []).map(d => <option key={d.id} value={d.date}>{formatDate(d.date)} ({getWeekday(d.date)})</option>)}</select></div>
                        <div className="flex gap-2 mb-2"><select value={newExpense.category} onChange={e => setNewExpense({...newExpense, category: e.target.value})} className="bg-gray-50 p-2 outline-none text-sm font-bold w-1/3 border border-gray-200 dashed-input">{CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}</select><input type="text" placeholder="ÂìÅÈ†Ö..." value={newExpense.item} onChange={e => setNewExpense({...newExpense, item: e.target.value})} className="flex-1 bg-transparent border-b-2 border-dashed border-gray-300 outline-none text-base font-bold text-gray-800 h-10 px-1" /></div>
                        <div className="flex gap-2 mb-2"><select value={newExpense.method} onChange={e => setNewExpense({...newExpense, method: e.target.value})} className="bg-gray-50 p-2 outline-none text-xs font-bold flex-1 border border-gray-200 text-gray-500 dashed-input">{paymentMethods.map(m => <option key={m} value={m}>{m}</option>)}</select><div className="relative flex-1"><select value={newExpense.platform} onChange={e => setNewExpense({...newExpense, platform: e.target.value})} className="w-full bg-gray-50 pl-2 pr-6 py-2 outline-none text-xs font-bold border border-gray-200 appearance-none h-10 dashed-input"><option value="">ÁÑ° / ÁèæÂ†¥</option>{bookingPlatforms.map(p => <option key={p} value={p}>{p}</option>)}</select><button onClick={() => setShowSettingsModal(true)} className="absolute right-1 top-1/2 -translate-y-1/2 text-gray-400 p-1"><Icons.Settings size={12}/></button></div></div>
                        <div className="flex gap-2 items-center"><button onClick={() => triggerFileAction('receipt')} className="bg-[#E0F2F1] text-[#00695C] w-12 h-12 border-2 border-[#80CBC4] shadow-sm active:scale-95 transition-transform flex items-center justify-center shrink-0 rounded-xl"><Icons.Camera size={24}/></button>
                        
                        {/* Merged Amount/Currency Input - Same as Modal */}
                        <div className="flex-1 flex items-center bg-gray-50 border-2 border-[#FFCCBC] px-2 h-12 rounded-xl overflow-hidden">
                            <input 
                                type="text" 
                                placeholder="ÈáëÈ°ç" 
                                value={newExpense.amount} 
                                readOnly
                                onClick={() => { setCalcTarget('expense'); setShowCalculator(true); }}
                                className="flex-1 bg-transparent border-none outline-none font-black text-xl text-[#E64A19] text-right pr-1 cursor-pointer" 
                            />
                            <div className="w-[1px] h-6 bg-gray-300 mx-1"></div>
                            <select 
                                value={newExpense.currency} 
                                onChange={e => setNewExpense({...newExpense, currency: e.target.value})} 
                                className="bg-transparent outline-none font-bold text-base w-16 text-center text-gray-700 appearance-none"
                            >
                                {CURRENCIES.map(c => <option key={c.code} value={c.code}>{c.code}</option>)}
                            </select>
                        </div>
                        
                        <button onClick={handleDirectAddExpense} className="bg-[#FF9F43] text-white w-12 h-12 shadow-md active:scale-95 transition-transform flex items-center justify-center shrink-0 rounded-xl"><Icons.Plus size={28}/></button></div>
                    </div>
                </div>
                <div className="flex-1 overflow-y-auto no-scrollbar pb-24 px-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    {(expenseFilter === 'all' ? expenses : expenses.filter(e => e.date === expenseFilter)).slice().reverse().map(expense => (
                        <div key={expense.id} className="bg-white p-3 border-2 border-gray-100 shadow-sm flex justify-between items-center h-20 animate-in fade-in slide-in-from-bottom-2 ticket-box">
                        <div className="flex-1 overflow-hidden"><div className="text-xs text-gray-500 font-bold mb-1">{formatDate(expense.date)} ‚Ä¢ {expense.category}</div><div className="text-lg font-bold text-gray-900 truncate pr-2">{expense.item}</div><div className="text-xs text-gray-400 font-bold mt-1">{expense.method} {expense.platform ? `/ ${expense.platform}` : ''}</div></div>
                        <div className="text-right shrink-0 flex items-center gap-1">
                            <div><div className="text-xl font-bold text-[#FF9F43]">{CURRENCIES.find(c => c.code === expense.currency)?.symbol}{expense.amount.toLocaleString()}</div>{expense.currency !== 'TWD' && <div className="text-xs text-gray-400 font-bold">‚âà ${Math.round(expense.amount * getExchangeRate(expense.currency))}</div>}</div>
                            <div className="flex flex-col">
                                <button onClick={() => handleEditExpense(expense)} className="text-gray-300 hover:text-blue-400 p-1"><Icons.Edit size={16}/></button>
                                <button onClick={() => handleDeleteExpense(expense.id)} className="text-gray-300 hover:text-red-400 p-1"><Icons.Trash2 size={16} /></button>
                            </div>
                        </div></div>
                    ))}
                    </div>
                </div>
                <CalculatorModal 
                  isOpen={showCalculator && calcTarget === 'expense'} 
                  onClose={() => setShowCalculator(false)} 
                  onConfirm={(val) => setNewExpense(prev => ({ ...prev, amount: val }))} 
                  initialValue={newExpense.amount}
              />
              </div>
            )}

            {/* Shopping Tab */}
            {activeTab === 'shopping' && (
              <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar">
                <div className="flex gap-2 text-white mb-4"><div className="flex-1 bg-[#FF6B81] p-3 border-2 border-black shadow-md ticket-box"><div className="text-sm font-bold opacity-90">üôÜ‚Äç‚ôÄÔ∏è Ëá™Áî®</div><div className="font-bold text-2xl">¬•{shoppingStats.selfTotal.toLocaleString()}</div></div><div className="flex-1 bg-[#6C5CE7] p-3 border-2 border-black shadow-md ticket-box"><div className="text-sm font-bold opacity-90">üì¶ ‰ª£Ë≥ºÊî∂</div><div className="font-bold text-2xl text-white">${Math.round(shoppingStats.agentTotal * getExchangeRate('JPY')).toLocaleString()}</div></div></div>
                {Object.keys(agentSummary).length > 0 && (<div className="bg-[#E8EAF6] p-4 border-2 border-[#C5CAE9] mb-4 shadow-sm ticket-box"><h3 className="font-bold text-[#3949AB] mb-2 flex items-center gap-2"><Icons.Coins size={20}/> ‰ª£Ë≥ºÁµêÁÆó (ÊØè‰∫∫Á∏ΩË®à)</h3><div className="space-y-2">{Object.entries(agentSummary).map(([name, totals]) => (<div key={name} className="flex justify-between items-center bg-white/60 p-2 rounded-xl"><span className="font-bold text-gray-700">{name}</span><div className="text-right"><div className="text-sm font-bold text-gray-500">¬•{totals.jpy.toLocaleString()}</div><div className="text-lg font-black text-[#3949AB]">${totals.twd.toLocaleString()}</div></div></div>))}</div></div>)}
                <div className="bg-white p-5 shadow-lg border-2 border-gray-100 mb-6 rounded-2xl"><div className="flex bg-gray-100 p-1 mb-3 border-2 border-gray-200 rounded-xl">{['self', 'agent', 'split'].map(type => ( <button key={type} onClick={() => setNewShopItem({...newShopItem, type})} className={`flex-1 py-2 text-lg font-bold transition-all rounded-lg ${newShopItem.type === type ? 'bg-white shadow text-black' : 'text-gray-400'}`}>{type === 'self' ? 'Ëá™Áî®' : type === 'agent' ? '‰ª£Ë≥º' : 'ÂàÜÂ∏≥'}</button> ))}</div><div className="flex gap-2 mb-2"><button onClick={() => { setBatchType('shopping'); setShowBatchModal(true); }} className="w-full bg-[#E0F2F1] text-[#00695C] py-2 font-bold mb-1 border-2 border-[#80CBC4] flex items-center justify-center gap-2 rounded-xl"><Icons.ListPlus size={20}/> ÊâπÊ¨°ÂåØÂÖ•</button></div><div className="flex gap-3 mb-3"><select value={newShopItem.priority} onChange={e => setNewShopItem({...newShopItem, priority: e.target.value})} className="bg-gray-50 border-2 border-gray-200 px-2 outline-none text-base font-bold w-32 dashed-input"><option value="high">üî¥ ÂøÖË≤∑</option><option value="medium">üü° ÈÅ∏Ë≥º</option><option value="low">üü¢ ÂèØË≤∑</option></select><input placeholder="Êà∞Âà©ÂìÅÂêçÁ®±..." value={newShopItem.item} onChange={e => setNewShopItem({...newShopItem, item: e.target.value})} className="flex-1 bg-gray-50 border-2 border-gray-200 px-4 py-3 outline-none font-bold text-xl text-gray-800 dashed-input" /></div><div className="flex gap-3 mb-3"><input type="text" placeholder="Êó•Âπ£ ¬•" value={newShopItem.budget} readOnly onClick={()=>{ setCalcTarget('shopping'); setShowCalculator(true); }} className="flex-1 bg-gray-50 border-2 border-gray-200 px-4 py-3 outline-none text-xl font-bold dashed-input cursor-pointer text-center" /></div>{(newShopItem.type === 'agent' || newShopItem.type === 'split') && ( <div className="flex gap-3 mb-3 animate-in fade-in">{newShopItem.type === 'agent' && <input placeholder="Âπ´Ë™∞Ë≤∑?" value={newShopItem.note} onChange={e => setNewShopItem({...newShopItem, note: e.target.value})} className="flex-1 bg-[#EDE7F6] border-2 border-[#6C5CE7] px-4 py-3 outline-none text-[#6C5CE7] font-bold text-lg dashed-input" />}{newShopItem.type === 'split' && <div className="flex-1 flex items-center bg-[#FFF3E0] border-2 border-[#FFA502] px-4 text-[#FFA502] font-bold dashed-input"><span className="text-sm mr-2">‰∫∫Êï∏:</span><input type="number" value={newShopItem.splitCount} onChange={e => setNewShopItem({...newShopItem, splitCount: e.target.value})} className="w-full bg-transparent outline-none text-xl" /></div>}</div> )}<button onClick={handleAddShoppingItem} className="w-full bg-[#FF6B81] text-white py-3 border-2 border-black korean-3d-btn font-bold text-xl flex items-center justify-center gap-2 mt-2 rounded-xl"><Icons.Plus size={24}/> Âä†ÂÖ•Ê∏ÖÂñÆ</button></div>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                  {(shoppingList || []).filter(i => !i.bought).map(item => (
                    <div key={item.id} className="bg-white p-4 border-4 shadow-sm flex items-center justify-between ticket-box" style={{ borderColor: item.type === 'agent' ? '#6C5CE7' : item.type === 'split' ? '#FFA502' : '#FF6B81' }}>
                        <div className="flex items-center gap-4 cursor-pointer w-full" onClick={() => handleShoppingItemClick(item)}>
                            <div className={`w-4 h-full self-stretch rounded-full ${item.type === 'agent' ? 'bg-[#6C5CE7]' : item.type === 'split' ? 'bg-[#FFA502]' : 'bg-[#FF6B81]'}`}></div>
                            <div className="flex-1 overflow-hidden">
                                <div className="flex items-center gap-2"><span className={`text-xs px-2 py-1 rounded-lg shrink-0 text-white font-bold shadow-sm ${item.priority === 'high' ? 'bg-red-500' : item.priority === 'medium' ? 'bg-yellow-400' : 'bg-green-400'}`}>{item.priority === 'high' ? 'ÂøÖË≤∑' : item.priority === 'medium' ? 'ÈÅ∏Ë≥º' : 'ÂèØË≤∑'}</span><span className="font-bold text-xl text-gray-800 truncate">{item.item}</span></div>
                                <div className="text-sm text-gray-500 font-bold mt-1 flex items-center gap-2">
                                    <span className="bg-gray-100 px-2 rounded">¬•{item.budget.toLocaleString()}</span><span className="text-gray-300">‚ûú</span><span className="text-gray-900 font-bold text-lg">{item.type === 'split' ? `$${Math.round((item.budget * getExchangeRate('JPY')) / item.splitCount)} /‰∫∫` : `$${Math.round(item.budget * getExchangeRate('JPY'))}`}</span>
                                    {item.expenseId && <span className="text-[10px] bg-orange-100 text-orange-600 px-1 rounded border border-orange-200">Â∑≤Ë®òÂ∏≥</span>}
                                </div>
                                {(item.type === 'agent' || item.type === 'split') && ( <div className="text-xs font-bold text-gray-400 mt-2 bg-gray-50 w-fit px-2 py-1 rounded">{item.type === 'agent' ? `Áµ¶: ${item.note}` : `${item.splitCount}‰∫∫ÂàÜÂ∏≥`}</div> )}
                            </div>
                        </div>
                        <button onClick={() => deleteShoppingItem(item.id)} className="text-gray-300 p-2 shrink-0 hover:text-red-400"><Icons.Trash2 size={24}/></button>
                    </div>
                  ))}
                </div>
                {(shoppingList || []).filter(i => i.bought).length > 0 && <div className="text-gray-400 text-lg font-bold mt-6 mb-3 border-b-2 border-gray-200 pb-1">Â∑≤Ë≥ºË≤∑ÂÆåÊàê</div>}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">{(shoppingList || []).filter(i => i.bought).map(item => (<div key={item.id} onClick={() => handleShoppingItemClick(item)} className="bg-gray-100 p-3 rounded-xl border-2 border-gray-200 flex items-center gap-3 opacity-60"><Icons.Check size={20} className="text-gray-500"/><span className="line-through text-gray-500 font-bold text-lg">{item.item}</span></div>))}</div>
                <CalculatorModal 
                  isOpen={showCalculator && calcTarget === 'shopping'} 
                  onClose={() => setShowCalculator(false)} 
                  onConfirm={(val) => setNewShopItem(prev => ({ ...prev, budget: val }))} 
                  initialValue={newShopItem.budget}
              />
              </div>
            )}
            
            {activeTab === 'packing' && (
                <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar">
                    <div className="bg-white p-4 shadow-lg border-2 border-gray-100 mb-6 rounded-2xl"><div className="flex gap-2"><input value={newCategoryName} onChange={e => setNewCategoryName(e.target.value)} placeholder="Êñ∞Â¢ûÂàÜÈ°ûÂêçÁ®± (Â¶Ç: ÊîùÂΩ±Ë£ùÂÇô)..." className="flex-1 bg-gray-50 border-2 border-gray-200 px-4 py-2 outline-none font-bold text-lg dashed-input" /><button onClick={addPackingCategory} className="bg-[#6C5CE7] text-white px-4 font-bold flex items-center rounded-xl"><Icons.Plus size={20}/> ÂàÜÈ°û</button></div><button onClick={() => { setBatchType('packing'); setShowBatchModal(true); }} className="w-full bg-[#E0F2F1] text-[#00695C] py-2 font-bold mt-2 border-2 border-[#80CBC4] flex items-center justify-center gap-2 rounded-xl"><Icons.ListPlus size={20}/> ÊâπÊ¨°ÂåØÂÖ•Ê∏ÖÂñÆ</button></div>
                    <div className="space-y-6">
                        {packingCategories.map(cat => {
                            const items = (packingList || []).filter(i => i.category === cat);
                            return (
                                <div key={cat} className="animate-in fade-in slide-in-from-bottom-2">
                                    <div className="flex justify-between items-center mb-3 ml-2"><h3 className="font-bold text-xl text-gray-800 flex items-center gap-2"><span className="w-2 h-6 bg-[#FF6B6B] rounded-full"></span>{cat}</h3><div className="flex gap-2"><button onClick={() => setActivePackingCategory(activePackingCategory === cat ? null : cat)} className={`p-1 rounded-lg border-2 ${activePackingCategory === cat ? 'bg-[#FF6B6B] text-white border-[#FF6B6B]' : 'bg-white text-gray-400 border-gray-300'} rounded-full`}><Icons.Plus size={18}/></button><button onClick={() => deletePackingCategory(cat)} className="text-gray-300 hover:text-red-400 p-1"><Icons.Trash2 size={18}/></button></div></div>
                                    {activePackingCategory === cat && (<div className="flex gap-2 mb-3 px-1"><input autoFocus value={newPackingItemText} onChange={e => setNewPackingItemText(e.target.value)} placeholder={`Êñ∞Â¢ûÁâ©ÂìÅÂà∞ ${cat}...`} className="flex-1 bg-white border-2 border-[#FF6B6B] px-3 py-2 outline-none font-bold text-lg dashed-input" /><button onClick={() => addPackingItemToCategory(cat)} className="bg-[#FF6B6B] text-white px-4 font-bold rounded-xl">Âä†ÂÖ•</button></div>)}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">{items.map(item => (<div key={item.id} onClick={() => togglePackingItem(item.id)} className={`p-4 border-2 flex items-center justify-between transition-all cursor-pointer ticket-box ${item.checked ? 'bg-gray-100 border-gray-200 opacity-60' : 'bg-white border-gray-200 shadow-sm'}`}><div className="flex items-center gap-4"><div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center ${item.checked ? 'bg-[#4ECDC4] border-[#4ECDC4]' : 'border-gray-300'}`}>{item.checked && <Icons.Check size={16} className="text-white"/>}</div><span className={`text-xl font-thin-hand ${item.checked ? 'line-through text-gray-400' : 'text-gray-800'}`}>{item.item}</span></div><button onClick={(e) => { e.stopPropagation(); deletePackingItem(item.id); }} className="text-gray-300 hover:text-red-400 p-2"><Icons.Trash2 size={20}/></button></div>))}</div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            )}
            
            {activeTab === 'info' && (
                <div className="h-full overflow-y-auto p-4 pb-24 no-scrollbar space-y-4">
                    <div className="grid grid-cols-2 gap-3">
                         <div className="space-y-2"><a href="https://www.vjw.digital.go.jp/" target="_blank" className="bg-white p-2 border border-blue-200 shadow-sm flex items-center gap-2 hover:bg-blue-50 ticket-box"><span className="text-xl">üáØüáµ</span><span className="text-blue-600 font-bold text-sm">VJW ÂÖ•Â¢É</span></a><a href="https://tenki.jp/" target="_blank" className="bg-white p-2 border border-blue-200 shadow-sm flex items-center gap-2 hover:bg-blue-50 ticket-box"><span className="text-xl">üå§Ô∏è</span><span className="text-blue-600 font-bold text-sm">Â§©Ê∞£ Tenki.jp</span></a><a href="https://www.google.com/finance/quote/JPY-TWD" target="_blank" className="bg-white p-2 border border-blue-200 shadow-sm flex items-center gap-2 hover:bg-blue-50 ticket-box"><span className="text-xl">üí∞</span><span className="text-blue-600 font-bold text-sm">Âç≥ÊôÇÂåØÁéá</span></a></div>
                         <div className="bg-[#FFEBEE] p-3 border border-[#FFCDD2] flex flex-col justify-between ticket-box"><div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-gray-700">üëÆ Â†±Ë≠¶</span><a href="tel:110" className="text-red-600 font-black">110</a></div><div className="flex justify-between items-center mb-2"><span className="text-xs font-bold text-gray-700">üöë ÊïëË≠∑</span><a href="tel:119" className="text-red-600 font-black">119</a></div><div className="flex flex-col gap-1 mt-1 border-t border-red-200 pt-1"><span className="text-xs font-bold text-gray-700">üáπüáº ÈßêÂ§ßÈò™Ëæ¶‰∫ãËôï</span><a href="tel:+81-90-8794-4568" className="text-red-600 font-black text-xs block text-right">Á∑äÊÄ•Â∞àÁ∑ö</a><a href="https://maps.google.com/?q=Â§ßÈò™Â∏ÇÂåóÂçÄ‰∏≠‰πãÂ≥∂2-3-18 ‰∏≠‰πãÂ≥∂Festival Tower 17Ê®ì" target="_blank" className="text-[10px] text-gray-500 underline leading-tight block text-right">Â§ßÈò™Â∏ÇÂåóÂçÄ‰∏≠‰πãÂ≥∂2-3-18<br/>‰∏≠‰πãÂ≥∂Festival Tower 17Ê®ì</a></div></div>
                    </div>
                    <div className="bg-[#E8EAF6] p-4 border-2 border-[#C5CAE9] rounded-2xl"><div className="flex justify-between items-center mb-2"><h3 className="font-bold text-xl text-[#3949AB] flex items-center gap-2"><Icons.Bed size={22}/> ‰ΩèÂÆøÊÉÖÂ†±</h3><button onClick={() => setShowAddHotel(!showAddHotel)} className="bg-[#3949AB] text-white px-3 py-1 text-sm font-bold rounded-lg">{showAddHotel ? 'ÂèñÊ∂à' : '+ Êñ∞Â¢û'}</button></div>{showAddHotel && (<div className="bg-white p-3 mb-3 animate-in fade-in rounded-xl"><div className="flex flex-col gap-1 mb-2"><label className="text-xs text-gray-500 font-bold">Check-in Êó•Êúü</label><input type="date" value={newHotel.date} onChange={e => setNewHotel({...newHotel, date: e.target.value})} className="border-b outline-none font-bold w-full" /></div><input placeholder="È£ØÂ∫óÂêçÁ®±" value={newHotel.name} onChange={e => setNewHotel({...newHotel, name: e.target.value})} className="w-full border-b mb-2 outline-none font-bold text-lg" /><input placeholder="Âú∞ÂùÄ (‰æõÂ∞éËà™Áî®)" value={newHotel.address} onChange={e => setNewHotel({...newHotel, address: e.target.value})} className="w-full border-b mb-2 outline-none text-sm" /><input placeholder="Ë®ÇÂñÆÁ∑®Ëôü/ÈõªË©±/ÂÇôË®ª" value={newHotel.note} onChange={e => setNewHotel({...newHotel, note: e.target.value})} className="w-full border-b mb-2 outline-none text-sm text-gray-500" /><button onClick={handleAddHotel} className="w-full bg-[#3949AB] text-white py-2 font-bold rounded-lg">ÂÑ≤Â≠òÈ£ØÂ∫ó</button></div>)}<div className="space-y-2">{(accommodations || []).sort((a,b) => new Date(a.date) - new Date(b.date)).map(h => (<div key={h.id} className="bg-white p-3 shadow-sm border border-[#C5CAE9] relative ticket-box"><div className="flex justify-between items-start"><div className="flex-1">{h.date && <div className="text-xs font-bold text-[#3949AB] bg-[#E8EAF6] w-fit px-2 rounded mb-1">{formatDate(h.date)} ({getWeekday(h.date)}) Check-in</div>}<div className="font-bold text-lg text-gray-800 pr-6">{h.name}</div></div></div>{h.address && <button onClick={(e) => openGoogleMaps(e, h.address)} className="text-blue-500 text-xs font-bold underline flex items-center gap-1 my-1"><Icons.Map size={12}/> {h.address}</button>}{h.note && <div className="text-sm text-gray-500 bg-gray-50 p-1 rounded mt-1">üìù {h.note}</div>}<button onClick={() => handleDeleteHotel(h.id)} className="absolute top-2 right-2 text-gray-300 hover:text-red-400"><Icons.Trash2 size={16}/></button></div>))}</div></div>
                    <div className="bg-[#E0F2F1] p-4 border-2 border-[#80CBC4] rounded-2xl"><div className="flex justify-between items-center mb-2"><h3 className="font-bold text-xl text-[#00695C] flex items-center gap-2"><Icons.Ticket size={22}/> È†êÁ¥ÑËªäË®ä</h3><button onClick={() => setShowAddReserv(!showAddReserv)} className="bg-[#00695C] text-white px-3 py-1 text-sm font-bold rounded-lg">{showAddReserv ? 'ÂèñÊ∂à' : '+ Êñ∞Â¢û'}</button></div>{showAddReserv && (<div className="bg-white p-3 mb-3 animate-in fade-in rounded-xl"><input placeholder="È†êÁ¥ÑÈ†ÖÁõÆ (Â¶Ç: HarukaËªäÁ•®)" value={newReserv.title} onChange={e => setNewReserv({...newReserv, title: e.target.value})} className="w-full border-b mb-2 outline-none font-bold" /><div className="flex flex-col gap-1 mb-2"><label className="text-xs text-gray-500 font-bold">Êó•ÊúüËàáÊôÇÈñì</label><input type="datetime-local" value={newReserv.time} onChange={e => setNewReserv({...newReserv, time: e.target.value})} className="w-full border-b outline-none text-sm" /></div><input placeholder="È†êÁ¥Ñ‰ª£Ëôü / Â∫ß‰Ωç / ÂÇôË®ª" value={newReserv.code} onChange={e => setNewReserv({...newReserv, code: e.target.value})} className="w-full border-b mb-2 outline-none text-sm text-gray-500" /><button onClick={handleAddReserv} className="w-full bg-[#00695C] text-white py-2 font-bold rounded-lg">ÂÑ≤Â≠òÈ†êÁ¥Ñ</button></div>)}<div className="space-y-2">{(reservations || []).sort((a,b) => new Date(a.time) - new Date(b.time)).map(r => (<div key={r.id} className="bg-white p-3 shadow-sm border border-[#80CBC4] relative ticket-box"><div className="flex justify-between items-start"><div>{r.time && <div className="text-xs font-bold bg-[#B2DFDB] text-[#00695C] px-2 py-1 rounded h-fit mb-1">{new Date(r.time).toLocaleString([], {month:'numeric', day:'numeric', weekday:'short', hour:'2-digit', minute:'2-digit'})}</div>}<div className="font-bold text-gray-800">{r.title}</div></div></div>{r.code && <div className="text-lg font-mono font-bold text-gray-600 mt-1 tracking-wider">{r.code}</div>}<button onClick={() => handleDeleteReserv(r.id)} className="absolute bottom-2 right-2 text-gray-300 hover:text-red-400"><Icons.Trash2 size={16}/></button></div>))}</div></div>
                    <div className="bg-[#FFF3E0] p-4 border-2 border-[#FFE0B2] rounded-2xl"><div className="flex justify-between items-center mb-2"><h3 className="font-bold text-xl text-[#E65100] flex items-center gap-2"><Icons.Utensils size={22}/> ÁæéÈ£üÁâπÊêú</h3><div className="flex gap-2"><button onClick={openAIGourmet} className="sparkle-btn px-2 py-1 text-sm font-bold shadow flex items-center gap-1 rounded-lg"><Icons.Sparkles size={14}/> AI Êé®Ëñ¶</button><button onClick={() => setShowAddGourmet(!showAddGourmet)} className="bg-[#E65100] text-white px-3 py-1 text-sm font-bold rounded-lg">{showAddGourmet ? 'ÂèñÊ∂à' : '+ Êñ∞Â¢û'}</button></div></div>{showAddGourmet && (<div className="bg-white p-3 mb-3 animate-in fade-in border-2 border-[#FFCCBC] rounded-xl"><div className="flex gap-2 mb-2"><select value={newGourmet.city} onChange={e => setNewGourmet({...newGourmet, city: e.target.value})} className="bg-gray-50 rounded p-1 text-sm font-bold outline-none">{CITIES.map(c => <option key={c} value={c}>{c}</option>)}</select><input placeholder="Â∫óÂêç (Â¶Ç: ÁáíËÇâÂäõ‰∏∏)" value={newGourmet.name} onChange={e => setNewGourmet({...newGourmet, name: e.target.value})} className="flex-1 border-b outline-none font-bold" /></div><input placeholder="Âú∞Èªû/ÂàÜÂ∫ó (‰æõÂ∞éËà™Áî®)" value={newGourmet.location} onChange={e => setNewGourmet({...newGourmet, location: e.target.value})} className="w-full border-b mb-2 outline-none text-sm" /><div onClick={() => triggerFileAction('gourmetPhoto', 'new')} className="w-full h-24 bg-gray-50 border-2 border-dashed border-gray-300 flex items-center justify-center mb-2 cursor-pointer overflow-hidden rounded-xl">{newGourmet.photo ? <img src={newGourmet.photo} className="w-full h-full object-cover"/> : <span className="text-gray-400 text-xs flex items-center gap-1"><Icons.Camera size={14}/> ‰∏äÂÇ≥ÁæéÈ£üÁÖß</span>}</div><input placeholder="ÂøÖÂêÉ/ÂÇôË®ª..." value={newGourmet.note} onChange={e => setNewGourmet({...newGourmet, note: e.target.value})} className="w-full border-b mb-2 outline-none text-sm text-gray-500" /><button onClick={handleAddGourmet} className="w-full bg-[#E65100] text-white py-2 font-bold rounded-lg">Âä†ÂÖ•Ê∏ÖÂñÆ</button></div>)}<div className="grid grid-cols-2 gap-3">{(gourmetList || []).map(g => (<div key={g.id} className="bg-white shadow-sm border border-[#FFE0B2] overflow-hidden relative flex flex-col ticket-box"><div onClick={() => triggerFileAction('gourmetPhoto', g.id)} className="h-24 bg-gray-100 w-full relative group cursor-pointer">{g.photo ? <img src={g.photo} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-300"><Icons.Utensils size={30}/></div>}<div className="absolute inset-0 bg-black/20 hidden group-hover:flex items-center justify-center text-white font-bold text-xs">Êõ¥ÊèõÁÖßÁâá</div><span className="absolute top-1 left-1 bg-black/50 text-white text-[10px] px-1.5 py-0.5 rounded backdrop-blur-sm">{g.city}</span></div><div className="p-2 flex-1 flex flex-col"><div className="font-bold text-gray-800 text-sm mb-1 leading-tight">{g.name}</div>{g.location && <button onClick={(e) => openGoogleMaps(e, g.location)} className="text-blue-500 text-[10px] font-bold underline flex items-center gap-1 mb-1"><Icons.Map size={10}/> {g.location}</button>}{g.note && <div className="text-[10px] text-gray-500 bg-gray-50 p-1 rounded mt-auto">{g.note}</div>}</div><button onClick={() => handleDeleteGourmet(g.id)} className="absolute top-1 right-1 text-white drop-shadow-md hover:text-red-400"><Icons.Trash2 size={16}/></button></div>))}</div></div>
                    <div className="flex-1 flex flex-col"><h3 className="font-bold text-xl text-gray-800 mb-2 flex items-center gap-2"><Icons.ListPlus size={24}/> Ëá™Áî±ÂÇôÂøòÈåÑ</h3><textarea className="w-full h-40 bg-[#FFFDE7] border-2 border-[#FFF59D] p-4 text-gray-700 font-bold text-lg outline-none resize-none shadow-sm leading-relaxed dashed-input" placeholder="Âú®ÈÄôË£°Ë≤º‰∏äËà™Áè≠Ë≥áË®ä„ÄÅÈ£ØÂ∫óÂú∞ÂùÄ„ÄÅÊàñÊòØ‰ªª‰ΩïÊÉ≥Ë®ò‰∏ã‰æÜÁöÑ‰∫ãÊÉÖ..." value={memoContent} onChange={(e) => setMemoContent(e.target.value)}></textarea></div>
                </div>
            )}
          </div>

          <div className="bg-white border-t-2 border-gray-100 shrink-0 safe-area-bottom shadow-[0_-5px_15px_rgba(0,0,0,0.05)] grid grid-cols-5 gap-1 p-2 h-20 items-end pb-4 z-50 relative">
            <TabButton id="itinerary" IconComp={Icons.Map} label="Ë°åÁ®ã" bgColor="#FFECF2" activeColor="#FF6B81" />
            <TabButton id="expenses" IconComp={Icons.Coins} label="Ë®òÂ∏≥" bgColor="#FFF8E1" activeColor="#FFB74D" />
            <TabButton id="shopping" IconComp={Icons.ShoppingBag} label="Êà∞Âà©ÂìÅ" bgColor="#E0F2F1" activeColor="#4DB6AC" />
            <TabButton id="packing" IconComp={Icons.Suitcase} label="Ë°åÊùé" bgColor="#F3E5F5" activeColor="#BA68C8" />
            <TabButton id="info" IconComp={Icons.Info} label="Ë≥áË®ä" bgColor="#E3F2FD" activeColor="#64B5F6" />
          </div>

        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
